---
phase: 01-convex-backend
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/schema.ts
  - convex/_generated/api.d.ts
  - convex/_generated/dataModel.d.ts
  - .env.local
  - package.json
autonomous: true

must_haves:
  truths:
    - "Convex project is initialized and connected to cloud deployment"
    - "Task schema defines all required fields with proper validators"
    - "Activity history schema exists with task reference and change tracking"
    - "Indexes exist for status, priority, dueDate, and tags"
  artifacts:
    - path: "convex/schema.ts"
      provides: "Task and activity_history table definitions"
      contains: "defineSchema"
      exports: ["default"]
    - path: ".env.local"
      provides: "Convex deployment URL"
      contains: "CONVEX_URL"
    - path: "package.json"
      provides: "Convex dependency"
      contains: "convex"
  key_links:
    - from: "convex/schema.ts"
      to: "convex/_generated/"
      via: "npx convex dev generates types"
      pattern: "defineSchema.*tasks.*activity_history"
---

<objective>
Initialize Convex backend and define database schema for task management.

Purpose: Establish the data foundation for the entire v1.1 milestone. The schema defines the shape of all task data and activity tracking that subsequent phases will build upon.

Output: Working Convex deployment with task and activity_history tables, proper validators, and indexes.
</objective>

<execution_context>
@/Users/criswo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/criswo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-convex-backend/01-CONTEXT.md
@.planning/phases/01-convex-backend/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Convex Project</name>
  <files>
    - package.json
    - .env.local
    - convex/_generated/
  </files>
  <action>
1. Install Convex: `npm install convex`

2. Initialize Convex project: `npx convex dev`
   - This will prompt for project creation if new
   - Creates `convex/` folder structure
   - Generates `.env.local` with `CONVEX_URL`
   - Keep the dev server running in background or note the deployment URL

3. Verify connection by checking the Convex dashboard URL shown in terminal output

Note: If `npx convex dev` prompts for login, follow the auth flow. The dev command both initializes AND starts the local sync process.
  </action>
  <verify>
    - `ls convex/` shows `_generated/` folder
    - `cat .env.local` contains `CONVEX_URL=https://...convex.cloud`
    - `grep convex package.json` shows dependency
  </verify>
  <done>Convex project initialized with cloud deployment URL in .env.local</done>
</task>

<task type="auto">
  <name>Task 2: Define Task and Activity History Schema</name>
  <files>convex/schema.ts</files>
  <action>
Create `convex/schema.ts` with the following schema (per CONTEXT.md decisions):

```typescript
import { defineSchema, defineTable } from "convex/server";
import { v } from "convex/values";

// Reusable validators for enums
export const statusValidator = v.union(
  v.literal("backlog"),
  v.literal("in_progress"),
  v.literal("blocked"),
  v.literal("done")
);

export const priorityValidator = v.union(
  v.literal("low"),
  v.literal("medium"),
  v.literal("high"),
  v.literal("urgent")
);

export default defineSchema({
  tasks: defineTable({
    title: v.string(),
    description: v.optional(v.string()),
    status: statusValidator,
    priority: priorityValidator,
    tags: v.array(v.string()),
    dueDate: v.optional(v.number()), // timestamp in ms
    order: v.number(), // for manual reordering within columns
    archived: v.boolean(), // soft delete flag
    updatedAt: v.number(), // manual timestamp (ms since epoch)
    // Note: _id and _creationTime are automatic from Convex
  })
    // Compound index for querying by status with order
    .index("by_status_order", ["status", "order"])
    // Single-field indexes for filtering
    .index("by_priority", ["priority"])
    .index("by_dueDate", ["dueDate"])
    .index("by_archived", ["archived"]),

  activity_history: defineTable({
    taskId: v.id("tasks"),
    field: v.string(), // which field changed
    oldValue: v.optional(v.string()), // JSON stringified for flexibility
    newValue: v.optional(v.string()), // JSON stringified for flexibility
    userId: v.optional(v.string()), // null until auth implemented (Phase 3)
    // Note: _creationTime tracks when change occurred
  })
    .index("by_task", ["taskId"])
    .index("by_creation", ["_creationTime"]),
});
```

Schema decisions per CONTEXT.md:
- status: Union of 4 literals (Convex-idiomatic enum approach)
- priority: Named levels as union literals
- tags: Array of strings (multiple tags per task)
- order: Numeric for drag-drop reordering
- archived: Boolean for soft delete
- activity_history: Separate table with task reference, stores old/new as JSON strings

After creating the file, run `npx convex dev` (or ensure it's running) to push schema to deployment and regenerate types.
  </action>
  <verify>
    - `npx convex dev` completes without schema errors
    - Convex dashboard shows `tasks` and `activity_history` tables
    - `cat convex/_generated/dataModel.d.ts` contains Task and ActivityHistory types
  </verify>
  <done>Schema deployed with tasks (7 indexes-optimized fields) and activity_history (2 indexes) tables</done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Schema deployment verified:**
   ```bash
   npx convex dashboard
   ```
   Opens browser to Convex dashboard where you can see:
   - `tasks` table with columns: title, description, status, priority, tags, dueDate, order, archived, updatedAt
   - `activity_history` table with columns: taskId, field, oldValue, newValue, userId

2. **Types generated:**
   ```bash
   cat convex/_generated/dataModel.d.ts | grep -A5 "tasks"
   ```
   Should show TypeScript types matching schema.

3. **Validators exported:**
   The `statusValidator` and `priorityValidator` are exported from schema.ts for reuse in mutations.
</verification>

<success_criteria>
- [ ] Convex installed as dependency in package.json
- [ ] .env.local contains valid CONVEX_URL
- [ ] convex/schema.ts defines tasks table with all fields from CONTEXT.md
- [ ] convex/schema.ts defines activity_history table with change tracking fields
- [ ] Schema pushed to Convex cloud (tables visible in dashboard)
- [ ] Type definitions generated in convex/_generated/
</success_criteria>

<output>
After completion, create `.planning/phases/01-convex-backend/01-01-SUMMARY.md`
</output>
