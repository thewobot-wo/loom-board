---
phase: 04-mcp-integration
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/mcp/index.ts
  - src/mcp/convex-client.ts
  - src/mcp/tools/read.ts
  - src/mcp/tools/write.ts
  - tsconfig.mcp.json
  - tsconfig.json
  - package.json
  - .mcp.json
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "MCP server source lives under src/mcp/, not in a separate mcp-server/ sub-project"
    - "MCP dependencies are in root package.json, no separate mcp-server/package.json exists"
    - "MCP server compiles with tsconfig.mcp.json targeting Node.js (NodeNext)"
    - "MCP server starts without crashing when MCP_API_TOKEN is set to a real token"
    - ".mcp.json points to src/mcp/index.ts and has a non-empty token placeholder"
    - "Main tsconfig.json excludes src/mcp/ to prevent build contamination"
  artifacts:
    - path: "src/mcp/index.ts"
      provides: "MCP server entry point"
      contains: "McpServer"
    - path: "src/mcp/convex-client.ts"
      provides: "Fetch wrapper for Convex HTTP actions"
      contains: "callMcpApi"
    - path: "src/mcp/tools/read.ts"
      provides: "Read tool registrations"
      contains: "registerReadTools"
    - path: "src/mcp/tools/write.ts"
      provides: "Write tool registrations"
      contains: "registerWriteTools"
    - path: "tsconfig.mcp.json"
      provides: "Node.js TypeScript config for MCP server"
      contains: "NodeNext"
    - path: ".mcp.json"
      provides: "Claude Code MCP server config"
      contains: "src/mcp/index.ts"
  key_links:
    - from: ".mcp.json"
      to: "src/mcp/index.ts"
      via: "args array in MCP server command"
      pattern: "src/mcp/index\\.ts"
    - from: "src/mcp/index.ts"
      to: "src/mcp/tools/read.ts"
      via: "import registerReadTools"
      pattern: "from.*\\./tools/read"
    - from: "src/mcp/index.ts"
      to: "src/mcp/tools/write.ts"
      via: "import registerWriteTools"
      pattern: "from.*\\./tools/write"
    - from: "package.json"
      to: "@modelcontextprotocol/sdk"
      via: "dependencies"
      pattern: "@modelcontextprotocol/sdk"
---

<objective>
Restructure the MCP server from a separate mcp-server/ sub-project into src/mcp/ within the main package, and fix the .mcp.json token placeholder to prevent startup crashes.

Purpose: The CONTEXT.md decision (locked) requires MCP server code to live in the same package, sharing dependencies with the app. The current mcp-server/ sub-directory with its own package.json violates this. The empty MCP_API_TOKEN in .mcp.json causes the server to crash on startup.

Output: MCP server files at src/mcp/*, shared deps in root package.json, tsconfig.mcp.json for Node.js compilation, working .mcp.json config
</objective>

<execution_context>
@/Users/criswo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/criswo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-mcp-integration/04-CONTEXT.md
@mcp-server/src/index.ts
@mcp-server/src/convex-client.ts
@mcp-server/src/tools/read.ts
@mcp-server/src/tools/write.ts
@mcp-server/tsconfig.json
@mcp-server/package.json
@package.json
@tsconfig.json
@.mcp.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Move MCP source files and update dependencies</name>
  <files>src/mcp/index.ts, src/mcp/convex-client.ts, src/mcp/tools/read.ts, src/mcp/tools/write.ts, package.json, tsconfig.mcp.json</files>
  <action>
**Step 1: Create src/mcp/ directory structure:**
```
src/mcp/
  index.ts
  convex-client.ts
  tools/
    read.ts
    write.ts
```

**Step 2: Copy files from mcp-server/src/ to src/mcp/:**
Copy the contents of each file exactly as-is. The import paths within the MCP files use relative paths with `.js` extensions (e.g., `"./tools/read.js"`, `"../convex-client.js"`). These MUST be preserved because NodeNext module resolution requires explicit `.js` extensions in imports. Do NOT change any import paths -- they are already correct for NodeNext.

Files to copy:
- `mcp-server/src/index.ts` -> `src/mcp/index.ts`
- `mcp-server/src/convex-client.ts` -> `src/mcp/convex-client.ts`
- `mcp-server/src/tools/read.ts` -> `src/mcp/tools/read.ts`
- `mcp-server/src/tools/write.ts` -> `src/mcp/tools/write.ts`

**Step 3: Add MCP deps to root package.json:**
Add to `dependencies`:
- `"@modelcontextprotocol/sdk": "^1.25.0"`

Note: `zod` is already available via `convex` (Convex re-exports it), but the MCP tools import `zod` directly. Add it explicitly to be safe:
- `"zod": "^3.25.0"`

Add to `devDependencies`:
- `"tsx": "^4.19.0"`

**Step 4: Create tsconfig.mcp.json at project root:**
This is a separate tsconfig for the MCP server targeting Node.js. It does NOT extend the main tsconfig.json because the main one uses `"moduleResolution": "bundler"` and `"noEmit": true`, which are incompatible with Node.js MCP execution.

```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "NodeNext",
    "moduleResolution": "NodeNext",
    "outDir": "./build/mcp",
    "rootDir": "./src/mcp",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "declaration": false,
    "sourceMap": false,
    "isolatedModules": true
  },
  "include": ["src/mcp/**/*"],
  "exclude": ["build"]
}
```

Key differences from main tsconfig:
- `module: "NodeNext"` (not ESNext) -- required for Node.js MCP server
- `moduleResolution: "NodeNext"` (not bundler) -- allows .js extension imports
- Has `outDir` (main uses noEmit) -- but we run via tsx so outDir is just for type-checking
- No `jsx`, `DOM` libs, path aliases -- MCP server is pure Node.js

**Step 5: Exclude src/mcp/ from main tsconfig.json:**
The main `tsconfig.json` has `"include": ["src"]` which would include `src/mcp/` in the Vite build. MCP server uses NodeNext module resolution (incompatible with the main app's bundler resolution) and Node-only APIs. Add an exclude to prevent build contamination:

In `tsconfig.json`, add `"exclude"` after the `"include"` line:
```json
{
  "compilerOptions": { ... },
  "include": ["src", "convex/_generated"],
  "exclude": ["src/mcp"],
  "references": [{ "path": "./tsconfig.node.json" }]
}
```

This prevents:
- TypeScript errors from NodeNext vs bundler moduleResolution conflict
- Vite bundling Node-only MCP code into the browser app
- `.js` extension imports (valid in NodeNext) failing under bundler resolution

**Step 6: Delete the mcp-server/ directory entirely:**
Remove `mcp-server/` and all its contents (package.json, tsconfig.json, package-lock.json, node_modules/, src/).

**Step 7: Run `npm install` in the project root** to install the newly added dependencies.
  </action>
  <verify>
1. Verify src/mcp/ directory exists with all 4 files: `ls -R src/mcp/`
2. Verify mcp-server/ directory no longer exists: `ls mcp-server/ 2>&1` should fail
3. Verify root package.json has @modelcontextprotocol/sdk in dependencies: `grep modelcontextprotocol package.json`
4. Verify root package.json has tsx in devDependencies: `grep tsx package.json`
5. Verify tsconfig.mcp.json exists: `cat tsconfig.mcp.json`
6. Verify tsconfig.json excludes src/mcp: `grep "src/mcp" tsconfig.json`
7. Type-check MCP server: `npx tsc --project tsconfig.mcp.json --noEmit`
8. Type-check main app (should not error on src/mcp/): `npx tsc --noEmit`
9. Verify node_modules has the MCP SDK: `ls node_modules/@modelcontextprotocol/sdk/`
  </verify>
  <done>
MCP server source files live at src/mcp/ (index.ts, convex-client.ts, tools/read.ts, tools/write.ts). MCP dependencies (@modelcontextprotocol/sdk, zod, tsx) are in root package.json. tsconfig.mcp.json provides Node.js-targeted compilation. Main tsconfig.json excludes src/mcp/ to prevent build contamination. The mcp-server/ sub-project directory is deleted. `npx tsc --project tsconfig.mcp.json --noEmit` passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update .mcp.json path and fix token placeholder</name>
  <files>.mcp.json</files>
  <action>
Update `.mcp.json` to point to the new source location and fix the empty token:

```json
{
  "mcpServers": {
    "loom-board": {
      "command": "npx",
      "args": ["tsx", "src/mcp/index.ts"],
      "env": {
        "CONVEX_SITE_URL": "https://precise-monitor-542.convex.site",
        "MCP_API_TOKEN": "set-your-token-here"
      }
    }
  }
}
```

Two changes:
1. `args` path: `"mcp-server/src/index.ts"` -> `"src/mcp/index.ts"` (new location)
2. `MCP_API_TOKEN`: `""` -> `"set-your-token-here"` (non-empty placeholder so the server does not crash at module load; convex-client.ts checks `if (!MCP_API_TOKEN)` and throws -- a non-empty placeholder passes this check, and the user gets a meaningful 401 from Convex instead of a cryptic startup crash)

Do NOT change `CONVEX_SITE_URL` -- it is correct.
  </action>
  <verify>
1. Verify .mcp.json has new path: `grep "src/mcp/index.ts" .mcp.json`
2. Verify token is not empty: `grep "set-your-token-here" .mcp.json`
3. Verify the server can start (will fail on first real API call but should not crash on import): `timeout 3 npx tsx src/mcp/index.ts 2>&1 || true` -- should see "Loom Board MCP server started" on stderr, not a throw about missing env vars (since .mcp.json sets them, but when running manually we need to set them: `CONVEX_SITE_URL=https://precise-monitor-542.convex.site MCP_API_TOKEN=set-your-token-here timeout 3 npx tsx src/mcp/index.ts 2>&1 || true`)
  </verify>
  <done>
.mcp.json points to src/mcp/index.ts. MCP_API_TOKEN has a non-empty placeholder value "set-your-token-here" that prevents startup crashes. Users replace this with their actual token.
  </done>
</task>

</tasks>

<verification>
1. `ls src/mcp/index.ts src/mcp/convex-client.ts src/mcp/tools/read.ts src/mcp/tools/write.ts` -- all exist
2. `ls mcp-server/ 2>&1` -- directory does not exist
3. `npx tsc --project tsconfig.mcp.json --noEmit` -- passes
4. `grep "src/mcp/index.ts" .mcp.json` -- path updated
5. `grep "set-your-token-here" .mcp.json` -- token not empty
6. `grep modelcontextprotocol package.json` -- dep in root
</verification>

<success_criteria>
- MCP server code lives at src/mcp/ (not mcp-server/)
- Dependencies shared via root package.json
- Separate tsconfig.mcp.json for Node.js target
- .mcp.json has correct path and non-empty token placeholder
- Main tsconfig.json excludes src/mcp/ (no build contamination)
- TypeScript type-checking passes for both MCP server and main app
- No mcp-server/ sub-project remains
</success_criteria>

<output>
After completion, create `.planning/phases/04-mcp-integration/04-04-SUMMARY.md`
</output>
