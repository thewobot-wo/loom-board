---
phase: 04-mcp-integration
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - mcp-server/src/tools/write.ts
  - mcp-server/src/index.ts
  - .mcp.json
autonomous: false

must_haves:
  truths:
    - "Claude Code can create new tasks via MCP create_task tool"
    - "Claude Code can update task fields via MCP update_task tool"
    - "Claude Code can move tasks between columns via MCP move_task tool"
    - "Claude Code can delete or archive tasks via MCP tools"
    - "MCP server is configured in .mcp.json and Claude Code discovers all 9 tools"
  artifacts:
    - path: "mcp-server/src/tools/write.ts"
      provides: "Write MCP tool registrations (create, update, move, delete, archive)"
      min_lines: 80
    - path: ".mcp.json"
      provides: "Project-scoped MCP server configuration for Claude Code"
      contains: "loom-board"
  key_links:
    - from: "mcp-server/src/tools/write.ts"
      to: "convex/mcpApi.ts"
      via: "HTTP POST to /mcp/tasks/* endpoints"
      pattern: "/mcp/tasks/(create|update|move|delete|archive)"
    - from: ".mcp.json"
      to: "mcp-server/src/index.ts"
      via: "MCP server command configuration"
      pattern: "tsx.*index\\.ts"
---

<objective>
Add write tools (create_task, update_task, move_task, delete_task, archive_task) to the MCP server, configure `.mcp.json` for Claude Code discovery, and verify end-to-end functionality with a human checkpoint.

Purpose: Complete the MCP tool set so Claude Code can both read and write tasks. The .mcp.json config makes Claude Code auto-discover the server.
Output: 5 write tools registered, .mcp.json config, fully working MCP integration
</objective>

<execution_context>
@/Users/criswo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/criswo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-mcp-integration/04-CONTEXT.md
@.planning/phases/04-mcp-integration/04-02-SUMMARY.md
@mcp-server/src/tools/read.ts
@mcp-server/src/convex-client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement write MCP tools and configure .mcp.json</name>
  <files>mcp-server/src/tools/write.ts, mcp-server/src/index.ts, .mcp.json</files>
  <action>
**mcp-server/src/tools/write.ts:**
Create file that exports `registerWriteTools(server: McpServer)` registering 5 write tools.

**Tool 1: create_task**
- Description: "Create a new task on the board"
- Input schema:
  ```
  {
    title: z.string().describe("Task title (required)"),
    description: z.string().optional().describe("Task description"),
    status: z.enum(["backlog", "in_progress", "blocked", "done"]).optional().describe("Column (defaults to backlog)"),
    priority: z.enum(["low", "medium", "high", "urgent"]).optional().describe("Priority (defaults to medium)"),
    tags: z.array(z.string()).optional().describe("Tags"),
    dueDate: z.string().optional().describe("Due date as ISO string (e.g., 2026-02-15)")
  }
  ```
- Calls: `POST /mcp/tasks/create`
- Convert dueDate ISO string to timestamp (ms) before sending: `new Date(dueDate).getTime()`
- Returns: Formatted confirmation with created task details

**Tool 2: update_task**
- Description: "Update fields of an existing task"
- Input schema:
  ```
  {
    id: z.string().describe("Task ID to update"),
    title: z.string().optional().describe("New title"),
    description: z.string().optional().describe("New description"),
    priority: z.enum(["low", "medium", "high", "urgent"]).optional().describe("New priority"),
    tags: z.array(z.string()).optional().describe("New tags (replaces existing)"),
    dueDate: z.string().optional().describe("New due date as ISO string, or empty string to clear")
  }
  ```
- Calls: `POST /mcp/tasks/update` with `{ id, updates: { ...fields } }`
- Convert dueDate similarly. If dueDate is empty string, send undefined to clear it.
- Returns: Formatted confirmation with updated task details

**Tool 3: move_task**
- Description: "Move a task to a different column (status)"
- Input schema:
  ```
  {
    id: z.string().describe("Task ID to move"),
    status: z.enum(["backlog", "in_progress", "blocked", "done"]).describe("Target column")
  }
  ```
- Calls: `POST /mcp/tasks/move`
- Returns: Formatted confirmation like "Moved 'Task Title' to In Progress"

**Tool 4: delete_task**
- Description: "Permanently delete a task (cannot be undone)"
- Input schema: `{ id: z.string().describe("Task ID to permanently delete") }`
- Calls: `POST /mcp/tasks/delete`
- Returns: "Task permanently deleted."

**Tool 5: archive_task**
- Description: "Archive a task (soft delete, can be restored)"
- Input schema: `{ id: z.string().describe("Task ID to archive") }`
- Calls: `POST /mcp/tasks/archive`
- Returns: "Task archived successfully."

**Error handling:** Same pattern as read tools -- catch errors, return `{ content: [...], isError: true }`.

**Update mcp-server/src/index.ts:**
Add import and call for `registerWriteTools(server)` alongside existing `registerReadTools(server)`.

**Create .mcp.json at project root:**
```json
{
  "mcpServers": {
    "loom-board": {
      "command": "npx",
      "args": ["tsx", "mcp-server/src/index.ts"],
      "env": {
        "CONVEX_SITE_URL": "https://precise-monitor-542.convex.site",
        "MCP_API_TOKEN": ""
      }
    }
  }
}
```

NOTE: The `MCP_API_TOKEN` value is left empty in .mcp.json. The user must fill it in with the same token they set in the Convex dashboard. Add a comment-like entry or leave it for the user setup checkpoint.

IMPORTANT: Do NOT hardcode the actual API token in .mcp.json since this file will be committed to git. The user fills it in locally, or it can be set via environment variable.
  </action>
  <verify>
1. Run `cd mcp-server && npx tsc --noEmit` to verify TypeScript compiles
2. Verify write.ts exports `registerWriteTools`
3. Verify index.ts imports and calls both `registerReadTools` and `registerWriteTools`
4. Verify .mcp.json exists at project root with correct structure
5. Count total tools: should be 9 (4 read + 5 write)
  </verify>
  <done>
5 write tools registered (create_task, update_task, move_task, delete_task, archive_task). MCP server index.ts updated to register both read and write tools. .mcp.json created at project root.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete MCP integration: 9 tools (4 read + 5 write), Convex HTTP action backend with token auth, .mcp.json configuration. The full chain: Claude Code -> MCP server (stdio) -> Convex HTTP actions -> Convex database.</what-built>
  <how-to-verify>
**Prerequisites (one-time setup):**
1. Generate an API token: run `openssl rand -hex 32` in terminal, save the output
2. Set the token in Convex: go to Convex Dashboard -> Settings -> Environment Variables, add `MCP_API_TOKEN` with the generated token
3. Set your user ID in Convex: go to Convex Dashboard -> Data -> users table, copy your `_id` value, add as `MCP_USER_ID` environment variable
4. Update `.mcp.json` in the project root: paste the same API token as the `MCP_API_TOKEN` value
5. Restart Claude Code so it picks up the new MCP server from `.mcp.json`

**Verification steps:**
1. In Claude Code, ask: "Use the list_tasks tool to show me all tasks on the board" -- should return your current tasks
2. Ask: "Use the get_board_summary tool" -- should show column counts
3. Ask: "Use the create_task tool to create a test task titled 'MCP Test Task' with priority high" -- should create and confirm
4. Ask: "Use the list_tasks tool again" -- should show the new test task
5. Ask: "Use the delete_task tool to permanently delete the MCP Test Task" -- should confirm deletion
6. Ask: "Use the search_tasks tool to search for tasks with priority high" -- should return results

If any tool fails, check:
- Is `npx convex dev` running? (HTTP actions need active deployment)
- Are Convex env vars set? (MCP_API_TOKEN and MCP_USER_ID)
- Does `.mcp.json` have the correct token?
  </how-to-verify>
  <resume-signal>Type "approved" if all 9 MCP tools work correctly, or describe any issues encountered</resume-signal>
</task>

</tasks>

<verification>
1. `cd mcp-server && npx tsc --noEmit` passes
2. 9 total MCP tools registered (list_tasks, get_task, search_tasks, get_board_summary, create_task, update_task, move_task, delete_task, archive_task)
3. .mcp.json exists at project root with correct server config
4. Human verified end-to-end: Claude Code can read and write tasks via MCP
</verification>

<success_criteria>
- All 9 MCP tools are discoverable by Claude Code
- Claude Code can list, get, search, and summarize tasks (read)
- Claude Code can create, update, move, delete, and archive tasks (write)
- API token authentication prevents unauthorized access
- All requirements MCP-01 through MCP-08 are satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/04-mcp-integration/04-03-SUMMARY.md`
</output>
