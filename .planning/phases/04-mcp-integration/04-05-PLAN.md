---
phase: 04-mcp-integration
plan: 05
type: execute
wave: 2
depends_on: ["04-04"]
files_modified:
  - convex/mcpApi.ts
  - convex/http.ts
  - src/mcp/tools/read.ts
  - .planning/ROADMAP.md
  - .planning/STATE.md
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "search_tasks accepts an optional status filter parameter"
    - "Searching with status='blocked' returns only blocked tasks"
    - "Status filter combines with other filters using AND logic"
    - "ROADMAP.md shows Phase 4 progress accurately"
  artifacts:
    - path: "convex/mcpApi.ts"
      provides: "searchTasksInternal with status filter"
      contains: "status"
    - path: "src/mcp/tools/read.ts"
      provides: "search_tasks tool with status param in schema"
      contains: "status"
  key_links:
    - from: "src/mcp/tools/read.ts"
      to: "convex/mcpApi.ts"
      via: "POST /mcp/tasks/search with status in body"
      pattern: "status"
    - from: "convex/http.ts searchTasks handler"
      to: "convex/mcpApi.ts searchTasksInternal"
      via: "ctx.runQuery passing status arg"
      pattern: "status"
---

<objective>
Add status filter to search_tasks and update project tracking docs to reflect Phase 4 completion.

Purpose: Users cannot currently search for tasks by status (e.g., "show all blocked tasks"). The status parameter is missing from searchTasksInternal, the HTTP handler, and the MCP tool schema. Additionally, ROADMAP.md and STATE.md are stale, showing Phase 4 as "0/3 Not started" when all code is built.

Output: search_tasks supports optional status filter; ROADMAP.md and STATE.md reflect reality
</objective>

<execution_context>
@/Users/criswo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/criswo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-mcp-integration/04-CONTEXT.md
@convex/mcpApi.ts
@convex/http.ts
@src/mcp/tools/read.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add status filter to search_tasks across all layers</name>
  <files>convex/mcpApi.ts, convex/http.ts, src/mcp/tools/read.ts</files>
  <action>
**Layer 1: convex/mcpApi.ts -- searchTasksInternal**

Add `status` to the args validator:
```typescript
args: {
  userId: v.id("users"),
  text: v.optional(v.string()),
  priority: v.optional(v.string()),
  tags: v.optional(v.array(v.string())),
  dueDate: v.optional(v.any()),
  status: v.optional(v.string()),  // ADD THIS
},
```

Add status filtering in the handler, right after the existing priority filter block (around line 313):
```typescript
// Filter by status (exact match)
if (args.status) {
  tasks = tasks.filter((t) => t.status === args.status);
}
```

Place it after the priority filter and before the tags filter, following the same pattern.

**Layer 2: convex/mcpApi.ts -- searchTasks HTTP action**

In the `searchTasks` httpAction (around line 623), destructure `status` from the body:
```typescript
const { text, priority, tags, dueDate, status } = body;
```

Add status validation after the existing priority validation block:
```typescript
if (status !== undefined && !isValidStatus(status)) {
  return errorResponse(
    `Invalid status: "${status}". Must be one of: ${VALID_STATUSES.join(", ")}`,
    400
  );
}
```

Pass `status` to the internal query:
```typescript
const tasks = await ctx.runQuery(internal.mcpApi.searchTasksInternal, {
  userId,
  text,
  priority,
  tags,
  dueDate,
  status,  // ADD THIS
});
```

**Layer 3: src/mcp/tools/read.ts -- search_tasks tool schema**

In the `search_tasks` tool registration (the third server.tool call), add `status` to the Zod input schema, after the existing `priority` field:
```typescript
status: z
  .enum(["backlog", "in_progress", "blocked", "done"])
  .optional()
  .describe("Filter by status (column)"),
```

In the handler function, destructure `status` alongside existing params:
```typescript
async ({ text, priority, tags, dueDate, status }) => {
```

Pass it in the body:
```typescript
const body: Record<string, unknown> = {};
if (text !== undefined) body.text = text;
if (priority !== undefined) body.priority = priority;
if (status !== undefined) body.status = status;  // ADD THIS
if (tags !== undefined) body.tags = tags;
if (dueDate !== undefined) body.dueDate = dueDate;
```

**No changes needed to convex/http.ts routes** -- the searchTasks handler already uses POST, so the status field passes through the JSON body without route changes. But DO verify the import and route are unchanged.
  </action>
  <verify>
1. Run `npx convex dev --once` (or `npx convex deploy` if using prod) to push the updated Convex functions -- verify no errors
2. Run `npx tsc --project tsconfig.mcp.json --noEmit` to verify MCP tool schema compiles
3. Grep for status in searchTasksInternal args: `grep -A 8 "searchTasksInternal" convex/mcpApi.ts | head -10`
4. Grep for status in search_tasks tool schema: `grep -B2 -A2 "Filter by status" src/mcp/tools/read.ts`
  </verify>
  <done>
search_tasks accepts optional `status` parameter at all three layers: Convex internal query filters by status, HTTP action validates and passes status, MCP tool schema includes status enum. Filters combine with AND logic (matching existing filter pattern).
  </done>
</task>

<task type="auto">
  <name>Task 2: Update ROADMAP.md and STATE.md to reflect Phase 4 progress</name>
  <files>.planning/ROADMAP.md, .planning/STATE.md</files>
  <action>
**ROADMAP.md updates:**

1. In the Progress table, update Phase 4 row:
   - Change `0/3` to `5/5` (3 original plans + 2 gap closure plans)
   - Change `Not started` to `In progress` (gap closure still running)
   - Leave Completed as `-` (not fully done until gap closure finishes)

2. In the Phase 4 Plans section, update plan checkboxes:
   - Check off plans 01, 02, 03 (already executed)
   - Add plans 04 and 05 (gap closure plans)
   ```
   Plans:
   - [x] 04-01-PLAN.md -- Convex HTTP action endpoints with API token authentication
   - [x] 04-02-PLAN.md -- MCP server scaffold with read tools (list, get, search, summary)
   - [x] 04-03-PLAN.md -- MCP write tools (create, update, move, delete, archive) and .mcp.json config
   - [x] 04-04-PLAN.md -- Restructure MCP server into src/mcp/ and fix token placeholder
   - [x] 04-05-PLAN.md -- Add status filter to search and update tracking docs
   ```

3. Update the Plans count: `**Plans:** 5 plans` (was 3)

**STATE.md updates:**

1. Current Position:
   - Plan: `5 of 5 in current phase`
   - Status: `Gap closure complete`
   - Last activity: today's date with description

2. Performance Metrics:
   - Update Phase 04 row in the By Phase table to reflect 5 plans total

3. Session Continuity:
   - Update "Next up" to reference Phase 5 (Migration)
  </action>
  <verify>
1. Verify ROADMAP.md Phase 4 progress shows updated counts: `grep -A 2 "MCP Integration" .planning/ROADMAP.md`
2. Verify plan checkboxes include 04 and 05: `grep "04-0[45]" .planning/ROADMAP.md`
3. Verify STATE.md shows current phase status: `grep "Gap closure" .planning/STATE.md`
  </verify>
  <done>
ROADMAP.md accurately shows Phase 4 with 5 plans (3 original + 2 gap closure), all checked off. STATE.md reflects Phase 4 gap closure complete with next step being Phase 5.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --project tsconfig.mcp.json --noEmit` -- MCP server compiles with new status param
2. `grep "status" convex/mcpApi.ts | grep -c "args.status\|v.optional"` -- status in searchTasksInternal
3. `grep "Filter by status" src/mcp/tools/read.ts` -- status in MCP tool schema
4. `grep "5 plans" .planning/ROADMAP.md` -- plan count updated
</verification>

<success_criteria>
- search_tasks tool accepts optional status parameter (backlog, in_progress, blocked, done)
- Status filter works with AND logic alongside text, priority, tags, dueDate
- ROADMAP.md shows Phase 4 with 5/5 plans complete
- STATE.md reflects gap closure completion
</success_criteria>

<output>
After completion, create `.planning/phases/04-mcp-integration/04-05-SUMMARY.md`
</output>
