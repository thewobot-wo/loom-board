---
phase: 02-react-frontend
plan: 04
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - src/components/Task/TaskModal.tsx
  - src/components/Task/TaskModal.module.css
  - src/components/Task/index.ts
  - src/App.tsx
autonomous: true

must_haves:
  truths:
    - "User can click Add Task and see a modal"
    - "User can fill form and create a new task"
    - "User can click task menu and edit existing task"
    - "User can delete a task from edit modal"
    - "Keyboard shortcuts work: Escape closes, Cmd+Enter saves"
  artifacts:
    - path: "src/components/Task/TaskModal.tsx"
      provides: "Task create/edit modal with form"
      contains: "saveTask"
    - path: "src/components/Task/TaskModal.module.css"
      provides: "Modal styling matching original"
      contains: "modal"
  key_links:
    - from: "src/components/Task/TaskModal.tsx"
      to: "api.tasks.createTask"
      via: "useMutation on save"
      pattern: "createTask.*title"
    - from: "src/components/Task/TaskModal.tsx"
      to: "api.tasks.updateTask"
      via: "useMutation on save (edit mode)"
      pattern: "updateTask.*id"
    - from: "src/App.tsx"
      to: "TaskModal"
      via: "modal state management"
      pattern: "modalOpen.*TaskModal"
---

<objective>
Implement TaskModal for creating and editing tasks with full form controls.

Purpose: Enable task CRUD operations through a modal interface matching the original vanilla app's functionality.

Output: Working modal for create/edit/delete with keyboard shortcuts.
</objective>

<execution_context>
@/Users/criswo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/criswo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-react-frontend/02-CONTEXT.md
@.planning/phases/02-react-frontend/02-RESEARCH.md
@.planning/phases/02-react-frontend/02-02-SUMMARY.md
@convex/tasks.ts (createTask, updateTask, archiveTask mutations)
@loom-board.html (modal styles, lines 642-794)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TaskModal component with form</name>
  <files>
    src/components/Task/TaskModal.tsx
    src/components/Task/TaskModal.module.css
    src/components/Task/index.ts
  </files>
  <action>
Create src/components/Task/TaskModal.module.css:
```css
.overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.7);
  backdrop-filter: blur(4px);
  z-index: 200;
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 20px;
}

.modal {
  background: var(--bg-secondary);
  border-radius: var(--radius);
  width: 100%;
  max-width: 520px;
  max-height: 90vh;
  overflow: hidden;
  box-shadow: var(--shadow-hover);
  animation: slideUp 0.2s ease;
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px;
  border-bottom: 1px solid var(--border);
}

.header h2 {
  font-size: 18px;
  font-weight: 600;
  color: var(--text-primary);
}

.closeButton {
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 4px;
  border: none;
  background: transparent;
  color: var(--text-muted);
  font-size: 18px;
  opacity: 0.6;
  transition: opacity 0.2s;
}

.closeButton:hover {
  opacity: 1;
  background: var(--bg-tertiary);
}

.body {
  padding: 20px;
  overflow-y: auto;
  max-height: 60vh;
}

.formGroup {
  margin-bottom: 20px;
}

.formGroup label {
  display: block;
  margin-bottom: 6px;
  font-size: 13px;
  font-weight: 500;
  color: var(--text-secondary);
}

.formGroup input,
.formGroup select,
.formGroup textarea {
  width: 100%;
  padding: 10px 14px;
  background: var(--bg-primary);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text-primary);
  font-size: 14px;
  transition: var(--transition);
}

.formGroup input:focus,
.formGroup select:focus,
.formGroup textarea:focus {
  outline: none;
  border-color: var(--accent-blue);
}

.formGroup textarea {
  min-height: 100px;
  resize: vertical;
  font-family: inherit;
}

.formRow {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}

.priorityOptions {
  display: flex;
  gap: 8px;
}

.priorityOption {
  flex: 1;
  padding: 8px;
  text-align: center;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  cursor: pointer;
  font-size: 12px;
  font-weight: 500;
  transition: var(--transition);
  background: transparent;
}

.priorityOption:hover {
  background: var(--bg-tertiary);
}

.priorityOption.selected {
  border-color: currentColor;
  background: rgba(255, 255, 255, 0.05);
}

.priorityUrgent { color: var(--accent-red); }
.priorityHigh { color: var(--accent-yellow); }
.priorityMedium { color: var(--accent-blue); }
.priorityLow { color: var(--text-muted); }

.footer {
  display: flex;
  justify-content: flex-end;
  gap: 12px;
  padding: 16px 20px;
  border-top: 1px solid var(--border);
  background: var(--bg-tertiary);
}

.btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 14px;
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text-secondary);
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  transition: var(--transition);
}

.btn:hover {
  background: var(--border);
  border-color: var(--text-muted);
}

.btnPrimary {
  background: var(--accent-green);
  border-color: var(--accent-green);
  color: #000;
}

.btnPrimary:hover {
  background: #2ea043;
  border-color: #2ea043;
}

.btnDanger {
  background: rgba(248, 81, 73, 0.1);
  border-color: var(--accent-red);
  color: var(--accent-red);
  margin-right: auto;
}

.btnDanger:hover {
  background: rgba(248, 81, 73, 0.2);
}

.tagsInput {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.tagOption {
  padding: 6px 12px;
  border: 1px solid var(--border);
  border-radius: 20px;
  font-size: 12px;
  cursor: pointer;
  transition: var(--transition);
  background: transparent;
  color: var(--text-secondary);
}

.tagOption:hover {
  background: var(--bg-tertiary);
}

.tagOption.selected {
  border-color: var(--accent-blue);
  background: rgba(88, 166, 255, 0.1);
  color: var(--accent-blue);
}
```

Create src/components/Task/TaskModal.tsx:
```typescript
import { useState, useEffect, useCallback } from "react";
import { useMutation } from "convex/react";
import { api } from "../../../convex/_generated/api";
import type { Doc, Id } from "../../../convex/_generated/dataModel";
import { PRIORITY_CONFIG, type Status, type Priority } from "@/lib/constants";
import clsx from "clsx";
import styles from "./TaskModal.module.css";

interface TaskModalProps {
  isOpen: boolean;
  onClose: () => void;
  task?: Doc<"tasks"> | null;
  defaultStatus?: Status;
}

const TAG_OPTIONS = ["project", "research", "bug", "feature", "maintenance", "cruise"];

export function TaskModal({ isOpen, onClose, task, defaultStatus = "backlog" }: TaskModalProps) {
  const createTask = useMutation(api.tasks.createTask);
  const updateTask = useMutation(api.tasks.updateTask);
  const archiveTask = useMutation(api.tasks.archiveTask);

  const [title, setTitle] = useState("");
  const [description, setDescription] = useState("");
  const [priority, setPriority] = useState<Priority>("medium");
  const [selectedTags, setSelectedTags] = useState<string[]>(["project"]);
  const [dueDate, setDueDate] = useState("");
  const [isSubmitting, setIsSubmitting] = useState(false);

  const isEditing = !!task;

  // Reset form when modal opens/closes or task changes
  useEffect(() => {
    if (isOpen && task) {
      setTitle(task.title);
      setDescription(task.description ?? "");
      setPriority(task.priority as Priority);
      setSelectedTags(task.tags.length > 0 ? task.tags : ["project"]);
      setDueDate(task.dueDate ? new Date(task.dueDate).toISOString().split("T")[0] : "");
    } else if (isOpen) {
      setTitle("");
      setDescription("");
      setPriority("medium");
      setSelectedTags(["project"]);
      setDueDate("");
    }
  }, [isOpen, task]);

  const handleSave = useCallback(async () => {
    if (!title.trim()) return;
    setIsSubmitting(true);

    try {
      const taskData = {
        title: title.trim(),
        description: description.trim() || undefined,
        priority,
        tags: selectedTags,
        dueDate: dueDate ? new Date(dueDate).getTime() : undefined,
      };

      if (isEditing && task) {
        await updateTask({
          id: task._id,
          updates: taskData,
        });
      } else {
        await createTask({
          ...taskData,
          status: defaultStatus,
          order: Date.now(), // Simple ordering by creation time
        });
      }
      onClose();
    } catch (error) {
      console.error("Failed to save task:", error);
    } finally {
      setIsSubmitting(false);
    }
  }, [title, description, priority, selectedTags, dueDate, isEditing, task, defaultStatus, createTask, updateTask, onClose]);

  const handleDelete = useCallback(async () => {
    if (!task) return;
    setIsSubmitting(true);

    try {
      await archiveTask({ id: task._id });
      onClose();
    } catch (error) {
      console.error("Failed to delete task:", error);
    } finally {
      setIsSubmitting(false);
    }
  }, [task, archiveTask, onClose]);

  const toggleTag = (tag: string) => {
    setSelectedTags((prev) =>
      prev.includes(tag)
        ? prev.filter((t) => t !== tag)
        : [...prev, tag]
    );
  };

  // Keyboard shortcuts
  useEffect(() => {
    if (!isOpen) return;

    const handleKeyDown = (e: KeyboardEvent) => {
      if (e.key === "Escape") {
        onClose();
      }
      if (e.key === "Enter" && (e.metaKey || e.ctrlKey)) {
        e.preventDefault();
        handleSave();
      }
    };

    document.addEventListener("keydown", handleKeyDown);
    return () => document.removeEventListener("keydown", handleKeyDown);
  }, [isOpen, onClose, handleSave]);

  if (!isOpen) return null;

  return (
    <div className={styles.overlay} onClick={onClose}>
      <div className={styles.modal} onClick={(e) => e.stopPropagation()}>
        <div className={styles.header}>
          <h2>{isEditing ? "Edit Task" : "New Task"}</h2>
          <button className={styles.closeButton} onClick={onClose}>
            x
          </button>
        </div>

        <div className={styles.body}>
          <div className={styles.formGroup}>
            <label htmlFor="title">Title</label>
            <input
              id="title"
              type="text"
              value={title}
              onChange={(e) => setTitle(e.target.value)}
              placeholder="What needs to be done?"
              autoFocus
            />
          </div>

          <div className={styles.formGroup}>
            <label htmlFor="description">Description</label>
            <textarea
              id="description"
              value={description}
              onChange={(e) => setDescription(e.target.value)}
              placeholder="Add details..."
            />
          </div>

          <div className={styles.formRow}>
            <div className={styles.formGroup}>
              <label>Tags</label>
              <div className={styles.tagsInput}>
                {TAG_OPTIONS.map((tag) => (
                  <button
                    key={tag}
                    type="button"
                    className={clsx(styles.tagOption, {
                      [styles.selected]: selectedTags.includes(tag),
                    })}
                    onClick={() => toggleTag(tag)}
                  >
                    {tag}
                  </button>
                ))}
              </div>
            </div>
            <div className={styles.formGroup}>
              <label htmlFor="dueDate">Due Date</label>
              <input
                id="dueDate"
                type="date"
                value={dueDate}
                onChange={(e) => setDueDate(e.target.value)}
              />
            </div>
          </div>

          <div className={styles.formGroup}>
            <label>Priority</label>
            <div className={styles.priorityOptions}>
              {(Object.entries(PRIORITY_CONFIG) as [Priority, typeof PRIORITY_CONFIG.urgent][]).map(
                ([key, config]) => (
                  <button
                    key={key}
                    type="button"
                    className={clsx(
                      styles.priorityOption,
                      styles[`priority${key.charAt(0).toUpperCase()}${key.slice(1)}`],
                      { [styles.selected]: priority === key }
                    )}
                    onClick={() => setPriority(key)}
                  >
                    {config.label}
                  </button>
                )
              )}
            </div>
          </div>
        </div>

        <div className={styles.footer}>
          {isEditing && (
            <button
              className={clsx(styles.btn, styles.btnDanger)}
              onClick={handleDelete}
              disabled={isSubmitting}
            >
              Delete
            </button>
          )}
          <button
            className={styles.btn}
            onClick={onClose}
            disabled={isSubmitting}
          >
            Cancel
          </button>
          <button
            className={clsx(styles.btn, styles.btnPrimary)}
            onClick={handleSave}
            disabled={isSubmitting || !title.trim()}
          >
            {isSubmitting ? "Saving..." : "Save Task"}
          </button>
        </div>
      </div>
    </div>
  );
}
```

Update src/components/Task/index.ts:
```typescript
export { TaskCard } from "./TaskCard";
export { SortableTaskCard } from "./SortableTaskCard";
export { TaskSkeleton } from "./TaskSkeleton";
export { TaskModal } from "./TaskModal";
```
  </action>
  <verify>
- `npx tsc --noEmit` passes
- `ls src/components/Task/TaskModal.tsx src/components/Task/TaskModal.module.css` exists
  </verify>
  <done>
TaskModal component with form fields for title, description, priority, tags, and due date.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate TaskModal in App with state management</name>
  <files>
    src/App.tsx
  </files>
  <action>
Update src/App.tsx to manage modal state:
```typescript
import { useState, useCallback } from "react";
import { useQuery } from "convex/react";
import { api } from "../convex/_generated/api";
import type { Doc } from "../convex/_generated/dataModel";
import { Board } from "@/components/Board";
import { TaskModal } from "@/components/Task";
import type { Status } from "@/lib/constants";

function App() {
  const tasks = useQuery(api.tasks.listTasks);

  // Modal state
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingTask, setEditingTask] = useState<Doc<"tasks"> | null>(null);
  const [defaultStatus, setDefaultStatus] = useState<Status>("backlog");

  const handleAddTask = useCallback((status: Status) => {
    setEditingTask(null);
    setDefaultStatus(status);
    setIsModalOpen(true);
  }, []);

  const handleEditTask = useCallback((taskId: string) => {
    const task = tasks?.find((t) => t._id === taskId);
    if (task) {
      setEditingTask(task);
      setDefaultStatus(task.status as Status);
      setIsModalOpen(true);
    }
  }, [tasks]);

  const handleCloseModal = useCallback(() => {
    setIsModalOpen(false);
    setEditingTask(null);
  }, []);

  return (
    <main>
      <header
        style={{
          background: "var(--bg-secondary)",
          borderBottom: "1px solid var(--border)",
          padding: "16px 24px",
          position: "sticky",
          top: 0,
          zIndex: 50,
        }}
      >
        <div
          style={{
            maxWidth: "1800px",
            margin: "0 auto",
            display: "flex",
            justifyContent: "space-between",
            alignItems: "center",
          }}
        >
          <h1
            style={{
              fontSize: "22px",
              fontWeight: 600,
              color: "var(--text-primary)",
              letterSpacing: "-0.5px",
            }}
          >
            Loom Board
          </h1>
          <span
            style={{
              fontSize: "13px",
              color: "var(--text-muted)",
            }}
          >
            {tasks === undefined
              ? "Loading..."
              : `${tasks.length} task${tasks.length === 1 ? "" : "s"}`}
          </span>
        </div>
      </header>

      <Board onAddTask={handleAddTask} onEditTask={handleEditTask} />

      <TaskModal
        isOpen={isModalOpen}
        onClose={handleCloseModal}
        task={editingTask}
        defaultStatus={defaultStatus}
      />
    </main>
  );
}

export default App;
```
  </action>
  <verify>
- `npm run dev` - click "Add Task" button, modal opens
- Fill form and save - task appears in column
- Click task menu (...), modal opens with task data
- Edit and save - changes persist
- Delete button removes task
- Escape key closes modal
- Cmd+Enter saves task
- `npx tsc --noEmit` passes
  </verify>
  <done>
TaskModal integrated with App, create/edit/delete all working with keyboard shortcuts.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Click "Add Task" on any column - modal opens
2. Fill title, description, select priority/tags, set due date - all work
3. Click Save - task created in correct column
4. Click task menu (...) - edit modal opens with existing data
5. Change fields and Save - task updated
6. Click Delete - task removed (archived)
7. Escape closes modal without saving
8. Cmd+Enter saves and closes modal
</verification>

<success_criteria>
- Create new task works with all form fields
- Edit existing task works
- Delete (archive) task works
- Keyboard shortcuts: Escape close, Cmd+Enter save
- Form validation: empty title prevents save
- Modal styling matches original vanilla app
</success_criteria>

<output>
After completion, create `.planning/phases/02-react-frontend/02-04-SUMMARY.md`
</output>
