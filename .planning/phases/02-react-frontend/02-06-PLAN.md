---
phase: 02-react-frontend
plan: 06
type: execute
wave: 5
depends_on: ["02-05"]
files_modified:
  - package.json
  - src/components/History/HistoryPanel.tsx
  - src/components/History/HistoryPanel.module.css
  - src/components/History/index.ts
  - src/App.tsx
  - src/main.tsx
autonomous: true

must_haves:
  truths:
    - "User can click History button and see activity panel"
    - "Activity history shows recent changes with timestamps"
    - "Panel slides in from right side"
    - "Click outside or X button closes panel"
    - "Toast notifications appear for actions (create, update, delete)"
  artifacts:
    - path: "src/components/History/HistoryPanel.tsx"
      provides: "Sliding history panel"
      contains: "activity"
    - path: "src/components/History/HistoryPanel.module.css"
      provides: "Panel styling with slide animation"
      contains: "slideIn"
  key_links:
    - from: "src/components/History/HistoryPanel.tsx"
      to: "api.activityHistory.getRecentActivity"
      via: "useQuery"
      pattern: "useQuery.*getRecentActivity"
    - from: "src/main.tsx"
      to: "Toaster"
      via: "sonner toast provider"
      pattern: "Toaster"
---

<objective>
Implement activity history panel and toast notifications.

Purpose: Show users their recent actions and provide feedback for CRUD operations.

Output: Sliding history panel with activity log and toast notifications for all actions.
</objective>

<execution_context>
@/Users/criswo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/criswo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-react-frontend/02-CONTEXT.md
@.planning/phases/02-react-frontend/02-RESEARCH.md
@.planning/phases/02-react-frontend/02-05-SUMMARY.md
@convex/activityHistory.ts
@loom-board.html (history panel styles, lines 550-640)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Sonner and create HistoryPanel component</name>
  <files>
    package.json
    src/components/History/HistoryPanel.tsx
    src/components/History/HistoryPanel.module.css
    src/components/History/index.ts
  </files>
  <action>
Install Sonner for toast notifications:
```bash
npm install sonner
```

Create src/components/History/HistoryPanel.module.css:
```css
.overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.5);
  z-index: 99;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s, visibility 0.3s;
}

.overlay.active {
  opacity: 1;
  visibility: visible;
}

.panel {
  position: fixed;
  right: -400px;
  top: 0;
  width: 380px;
  height: 100vh;
  background: var(--bg-secondary);
  border-left: 1px solid var(--border);
  z-index: 100;
  transition: right 0.3s ease;
  display: flex;
  flex-direction: column;
}

.panel.active {
  right: 0;
}

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
}

.header h3 {
  font-size: 16px;
  font-weight: 600;
  color: var(--text-primary);
}

.closeButton {
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 4px;
  border: none;
  background: transparent;
  color: var(--text-muted);
  font-size: 18px;
}

.closeButton:hover {
  background: var(--bg-tertiary);
}

.list {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
}

.item {
  display: flex;
  gap: 12px;
  padding: 12px;
  border-radius: var(--radius-sm);
  margin-bottom: 8px;
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
}

.time {
  font-size: 11px;
  color: var(--text-muted);
  min-width: 60px;
  flex-shrink: 0;
}

.content {
  flex: 1;
  min-width: 0;
}

.action {
  font-size: 12px;
  color: var(--accent-blue);
  font-weight: 500;
  margin-bottom: 2px;
}

.taskTitle {
  font-size: 13px;
  color: var(--text-primary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.fieldChange {
  font-size: 11px;
  color: var(--text-muted);
  margin-top: 4px;
}

.empty {
  text-align: center;
  color: var(--text-muted);
  padding: 40px 20px;
  font-size: 14px;
}

.loading {
  text-align: center;
  color: var(--text-muted);
  padding: 40px 20px;
  font-size: 14px;
}

/* Skeleton items */
.skeleton {
  animation: pulse 1.5s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}
```

Create src/components/History/HistoryPanel.tsx:
```typescript
import { useQuery } from "convex/react";
import { api } from "../../../convex/_generated/api";
import { formatTime } from "@/lib/utils";
import styles from "./HistoryPanel.module.css";

interface HistoryPanelProps {
  isOpen: boolean;
  onClose: () => void;
}

export function HistoryPanel({ isOpen, onClose }: HistoryPanelProps) {
  const activities = useQuery(api.activityHistory.getRecentActivity, { limit: 50 });

  const formatAction = (field: string, oldValue?: string, newValue?: string): string => {
    if (field === "_created") return "Created";
    if (field === "archived") {
      return newValue === "true" ? "Archived" : "Restored";
    }
    if (field === "status") {
      const from = oldValue ? JSON.parse(oldValue) : "unknown";
      const to = newValue ? JSON.parse(newValue) : "unknown";
      return `Moved: ${from} → ${to}`;
    }
    return `Updated ${field}`;
  };

  return (
    <>
      <div
        className={`${styles.overlay} ${isOpen ? styles.active : ""}`}
        onClick={onClose}
      />
      <div className={`${styles.panel} ${isOpen ? styles.active : ""}`}>
        <div className={styles.header}>
          <h3>Activity History</h3>
          <button className={styles.closeButton} onClick={onClose}>
            x
          </button>
        </div>
        <div className={styles.list}>
          {activities === undefined ? (
            <div className={styles.loading}>Loading history...</div>
          ) : activities.length === 0 ? (
            <div className={styles.empty}>No activity yet</div>
          ) : (
            activities.map((activity) => (
              <div key={activity._id} className={styles.item}>
                <span className={styles.time}>
                  {formatTime(activity._creationTime)}
                </span>
                <div className={styles.content}>
                  <div className={styles.action}>
                    {formatAction(activity.field, activity.oldValue, activity.newValue)}
                  </div>
                  <div className={styles.taskTitle}>
                    {activity.taskTitle ?? "Unknown task"}
                  </div>
                  {activity.field !== "_created" && activity.field !== "archived" && activity.field !== "status" && (
                    <div className={styles.fieldChange}>
                      {activity.oldValue && `"${JSON.parse(activity.oldValue)}" → `}
                      {activity.newValue && `"${JSON.parse(activity.newValue)}"`}
                    </div>
                  )}
                </div>
              </div>
            ))
          )}
        </div>
      </div>
    </>
  );
}
```

Create src/components/History/index.ts:
```typescript
export { HistoryPanel } from "./HistoryPanel";
```
  </action>
  <verify>
- `npx tsc --noEmit` passes
- `npm ls sonner` shows installed
- `ls src/components/History/` shows HistoryPanel.tsx, HistoryPanel.module.css, index.ts
  </verify>
  <done>
HistoryPanel component created with activity display and Sonner installed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate HistoryPanel and Toaster in App</name>
  <files>
    src/main.tsx
    src/App.tsx
    src/components/Task/TaskModal.tsx
  </files>
  <action>
Update src/main.tsx to add Toaster:
```typescript
import { StrictMode } from "react";
import { createRoot } from "react-dom/client";
import { ConvexProvider, ConvexReactClient } from "convex/react";
import { Toaster } from "sonner";
import App from "./App";
import "./styles/globals.css";

const convex = new ConvexReactClient(import.meta.env.VITE_CONVEX_URL);

createRoot(document.getElementById("root")!).render(
  <StrictMode>
    <ConvexProvider client={convex}>
      <App />
      <Toaster
        theme="dark"
        position="bottom-right"
        toastOptions={{
          style: {
            background: "var(--bg-secondary)",
            border: "1px solid var(--border)",
            color: "var(--text-primary)",
          },
        }}
      />
    </ConvexProvider>
  </StrictMode>
);
```

Update src/App.tsx to add HistoryPanel state:
```typescript
import { useState, useCallback } from "react";
import { useQuery } from "convex/react";
import { api } from "../convex/_generated/api";
import type { Doc } from "../convex/_generated/dataModel";
import { useFilters } from "@/hooks";
import { Header } from "@/components/Header";
import { FilterBar } from "@/components/Filters";
import { Board } from "@/components/Board";
import { TaskModal } from "@/components/Task";
import { HistoryPanel } from "@/components/History";
import type { Status } from "@/lib/constants";

function App() {
  const tasks = useQuery(api.tasks.listTasks);

  // Filter state
  const {
    searchQuery,
    setSearchQuery,
    activeTags,
    toggleTag,
    clearFilters,
    hasActiveFilters,
    filteredTasks,
  } = useFilters(tasks);

  // Modal state
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingTask, setEditingTask] = useState<Doc<"tasks"> | null>(null);
  const [defaultStatus, setDefaultStatus] = useState<Status>("backlog");

  // History panel state
  const [isHistoryOpen, setIsHistoryOpen] = useState(false);

  const handleAddTask = useCallback((status: Status) => {
    setEditingTask(null);
    setDefaultStatus(status);
    setIsModalOpen(true);
  }, []);

  const handleEditTask = useCallback((taskId: string) => {
    const task = tasks?.find((t) => t._id === taskId);
    if (task) {
      setEditingTask(task);
      setDefaultStatus(task.status as Status);
      setIsModalOpen(true);
    }
  }, [tasks]);

  const handleCloseModal = useCallback(() => {
    setIsModalOpen(false);
    setEditingTask(null);
  }, []);

  const handleShowHistory = useCallback(() => {
    setIsHistoryOpen(true);
  }, []);

  const handleCloseHistory = useCallback(() => {
    setIsHistoryOpen(false);
  }, []);

  return (
    <main>
      <Header
        taskCount={filteredTasks?.length ?? 0}
        isLoading={tasks === undefined}
        onShowHistory={handleShowHistory}
      />

      <FilterBar
        searchQuery={searchQuery}
        onSearchChange={setSearchQuery}
        activeTags={activeTags}
        onTagToggle={toggleTag}
        onClearFilters={clearFilters}
        hasActiveFilters={hasActiveFilters}
      />

      <Board
        tasks={filteredTasks}
        onAddTask={handleAddTask}
        onEditTask={handleEditTask}
      />

      <TaskModal
        isOpen={isModalOpen}
        onClose={handleCloseModal}
        task={editingTask}
        defaultStatus={defaultStatus}
      />

      <HistoryPanel isOpen={isHistoryOpen} onClose={handleCloseHistory} />
    </main>
  );
}

export default App;
```

Update src/components/Task/TaskModal.tsx to show toasts:
```typescript
import { useState, useEffect, useCallback } from "react";
import { useMutation } from "convex/react";
import { toast } from "sonner";
import { api } from "../../../convex/_generated/api";
import type { Doc } from "../../../convex/_generated/dataModel";
import { PRIORITY_CONFIG, type Status, type Priority } from "@/lib/constants";
import clsx from "clsx";
import styles from "./TaskModal.module.css";

interface TaskModalProps {
  isOpen: boolean;
  onClose: () => void;
  task?: Doc<"tasks"> | null;
  defaultStatus?: Status;
}

const TAG_OPTIONS = ["project", "research", "bug", "feature", "maintenance", "cruise"];

export function TaskModal({ isOpen, onClose, task, defaultStatus = "backlog" }: TaskModalProps) {
  const createTask = useMutation(api.tasks.createTask);
  const updateTask = useMutation(api.tasks.updateTask);
  const archiveTask = useMutation(api.tasks.archiveTask);

  const [title, setTitle] = useState("");
  const [description, setDescription] = useState("");
  const [priority, setPriority] = useState<Priority>("medium");
  const [selectedTags, setSelectedTags] = useState<string[]>(["project"]);
  const [dueDate, setDueDate] = useState("");
  const [isSubmitting, setIsSubmitting] = useState(false);

  const isEditing = !!task;

  useEffect(() => {
    if (isOpen && task) {
      setTitle(task.title);
      setDescription(task.description ?? "");
      setPriority(task.priority as Priority);
      setSelectedTags(task.tags.length > 0 ? task.tags : ["project"]);
      setDueDate(task.dueDate ? new Date(task.dueDate).toISOString().split("T")[0] : "");
    } else if (isOpen) {
      setTitle("");
      setDescription("");
      setPriority("medium");
      setSelectedTags(["project"]);
      setDueDate("");
    }
  }, [isOpen, task]);

  const handleSave = useCallback(async () => {
    if (!title.trim()) {
      toast.error("Please enter a title");
      return;
    }
    setIsSubmitting(true);

    try {
      const taskData = {
        title: title.trim(),
        description: description.trim() || undefined,
        priority,
        tags: selectedTags,
        dueDate: dueDate ? new Date(dueDate).getTime() : undefined,
      };

      if (isEditing && task) {
        await updateTask({
          id: task._id,
          updates: taskData,
        });
        toast.success("Task updated");
      } else {
        await createTask({
          ...taskData,
          status: defaultStatus,
          order: Date.now(),
        });
        toast.success("Task created");
      }
      onClose();
    } catch (error) {
      toast.error("Failed to save task");
      console.error("Failed to save task:", error);
    } finally {
      setIsSubmitting(false);
    }
  }, [title, description, priority, selectedTags, dueDate, isEditing, task, defaultStatus, createTask, updateTask, onClose]);

  const handleDelete = useCallback(async () => {
    if (!task) return;
    setIsSubmitting(true);

    try {
      await archiveTask({ id: task._id });
      toast.success("Task deleted");
      onClose();
    } catch (error) {
      toast.error("Failed to delete task");
      console.error("Failed to delete task:", error);
    } finally {
      setIsSubmitting(false);
    }
  }, [task, archiveTask, onClose]);

  const toggleTag = (tag: string) => {
    setSelectedTags((prev) =>
      prev.includes(tag)
        ? prev.filter((t) => t !== tag)
        : [...prev, tag]
    );
  };

  useEffect(() => {
    if (!isOpen) return;

    const handleKeyDown = (e: KeyboardEvent) => {
      if (e.key === "Escape") {
        onClose();
      }
      if (e.key === "Enter" && (e.metaKey || e.ctrlKey)) {
        e.preventDefault();
        handleSave();
      }
    };

    document.addEventListener("keydown", handleKeyDown);
    return () => document.removeEventListener("keydown", handleKeyDown);
  }, [isOpen, onClose, handleSave]);

  if (!isOpen) return null;

  return (
    <div className={styles.overlay} onClick={onClose}>
      <div className={styles.modal} onClick={(e) => e.stopPropagation()}>
        <div className={styles.header}>
          <h2>{isEditing ? "Edit Task" : "New Task"}</h2>
          <button className={styles.closeButton} onClick={onClose}>
            x
          </button>
        </div>

        <div className={styles.body}>
          <div className={styles.formGroup}>
            <label htmlFor="title">Title</label>
            <input
              id="title"
              type="text"
              value={title}
              onChange={(e) => setTitle(e.target.value)}
              placeholder="What needs to be done?"
              autoFocus
            />
          </div>

          <div className={styles.formGroup}>
            <label htmlFor="description">Description</label>
            <textarea
              id="description"
              value={description}
              onChange={(e) => setDescription(e.target.value)}
              placeholder="Add details..."
            />
          </div>

          <div className={styles.formRow}>
            <div className={styles.formGroup}>
              <label>Tags</label>
              <div className={styles.tagsInput}>
                {TAG_OPTIONS.map((tag) => (
                  <button
                    key={tag}
                    type="button"
                    className={clsx(styles.tagOption, {
                      [styles.selected]: selectedTags.includes(tag),
                    })}
                    onClick={() => toggleTag(tag)}
                  >
                    {tag}
                  </button>
                ))}
              </div>
            </div>
            <div className={styles.formGroup}>
              <label htmlFor="dueDate">Due Date</label>
              <input
                id="dueDate"
                type="date"
                value={dueDate}
                onChange={(e) => setDueDate(e.target.value)}
              />
            </div>
          </div>

          <div className={styles.formGroup}>
            <label>Priority</label>
            <div className={styles.priorityOptions}>
              {(Object.entries(PRIORITY_CONFIG) as [Priority, typeof PRIORITY_CONFIG.urgent][]).map(
                ([key, config]) => (
                  <button
                    key={key}
                    type="button"
                    className={clsx(
                      styles.priorityOption,
                      styles[`priority${key.charAt(0).toUpperCase()}${key.slice(1)}`],
                      { [styles.selected]: priority === key }
                    )}
                    onClick={() => setPriority(key)}
                  >
                    {config.label}
                  </button>
                )
              )}
            </div>
          </div>
        </div>

        <div className={styles.footer}>
          {isEditing && (
            <button
              className={clsx(styles.btn, styles.btnDanger)}
              onClick={handleDelete}
              disabled={isSubmitting}
            >
              Delete
            </button>
          )}
          <button
            className={styles.btn}
            onClick={onClose}
            disabled={isSubmitting}
          >
            Cancel
          </button>
          <button
            className={clsx(styles.btn, styles.btnPrimary)}
            onClick={handleSave}
            disabled={isSubmitting || !title.trim()}
          >
            {isSubmitting ? "Saving..." : "Save Task"}
          </button>
        </div>
      </div>
    </div>
  );
}
```
  </action>
  <verify>
- `npm run dev` - click History button, panel slides in from right
- Activity shows recent changes with timestamps
- Click outside panel or X to close
- Create task - toast shows "Task created"
- Edit task - toast shows "Task updated"
- Delete task - toast shows "Task deleted"
- Toasts appear in bottom-right with dark theme
- `npx tsc --noEmit` passes
  </verify>
  <done>
History panel and toast notifications working, all CRUD operations show feedback.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Click "History" button - panel slides in from right
2. Activity log shows recent actions with timestamps
3. Actions show: Created, Moved, Updated [field], Archived, Restored
4. Task titles shown for each activity
5. Click overlay or X closes panel
6. Create task shows "Task created" toast
7. Edit task shows "Task updated" toast
8. Delete task shows "Task deleted" toast
9. Toasts styled to match dark theme
</verification>

<success_criteria>
- History panel slides in/out smoothly
- Activity history from Convex displays correctly
- Toast notifications for create/update/delete
- Panel closes on overlay click or X button
- Dark theme styling consistent
- TypeScript compiles with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-react-frontend/02-06-SUMMARY.md`
</output>
