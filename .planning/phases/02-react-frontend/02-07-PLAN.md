---
phase: 02-react-frontend
plan: 07
type: execute
wave: 6
depends_on: ["02-06"]
files_modified:
  - package.json
  - convex/tasks.ts
  - src/components/Archive/ArchiveSection.tsx
  - src/components/Archive/ArchiveSection.module.css
  - src/components/Archive/index.ts
  - src/hooks/useKeyboardShortcuts.ts
  - src/hooks/useAutoArchive.ts
  - src/hooks/index.ts
  - src/App.tsx
autonomous: false

must_haves:
  truths:
    - "Done tasks older than 7 days auto-archive"
    - "Archive section toggles open/closed"
    - "Archived tasks can be restored"
    - "Keyboard shortcuts work globally"
    - "Full feature parity with vanilla app verified"
  artifacts:
    - path: "convex/tasks.ts"
      provides: "listArchivedTasks query"
      contains: "listArchivedTasks"
    - path: "src/components/Archive/ArchiveSection.tsx"
      provides: "Collapsible archive section"
      contains: "archived"
    - path: "src/hooks/useAutoArchive.ts"
      provides: "Auto-archive logic"
      contains: "7 days"
    - path: "src/hooks/useKeyboardShortcuts.ts"
      provides: "Global keyboard handler"
      contains: "useHotkeys"
  key_links:
    - from: "src/hooks/useAutoArchive.ts"
      to: "api.tasks.archiveTask"
      via: "mutation for old done tasks"
      pattern: "archiveTask"
    - from: "src/App.tsx"
      to: "useKeyboardShortcuts"
      via: "hook in App component"
      pattern: "useKeyboardShortcuts"
    - from: "src/App.tsx"
      to: "api.tasks.listArchivedTasks"
      via: "useQuery for archived tasks"
      pattern: "listArchivedTasks"
---

<objective>
Implement auto-archive, archive section, and keyboard shortcuts for feature parity.

Purpose: Complete the remaining features from the vanilla app: auto-archive old done tasks, archive UI, and global keyboard shortcuts.

Output: Full feature parity with vanilla app, ready for user verification.
</objective>

<execution_context>
@/Users/criswo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/criswo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-react-frontend/02-CONTEXT.md
@.planning/phases/02-react-frontend/02-RESEARCH.md
@.planning/phases/02-react-frontend/02-06-SUMMARY.md
@convex/tasks.ts (archiveTask, restoreTask mutations)
@convex/schema.ts (by_archived index already exists)
@loom-board.html (archive section, keyboard handling)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add listArchivedTasks query and install react-hotkeys-hook</name>
  <files>
    package.json
    convex/tasks.ts
  </files>
  <action>
Install react-hotkeys-hook:
```bash
npm install react-hotkeys-hook
```

Add to convex/tasks.ts (append after restoreTask mutation):
```typescript
// READ: List all archived tasks
export const listArchivedTasks = query({
  args: {},
  handler: async (ctx) => {
    // Uses existing by_archived index from schema.ts
    return await ctx.db
      .query("tasks")
      .withIndex("by_archived", (q) => q.eq("archived", true))
      .collect();
  },
});
```

Run `npx convex dev --once` to push the new query.

Note: The schema already has `.index("by_archived", ["archived"])` defined, so the query can use this index directly.
  </action>
  <verify>
- `npx convex dev --once` deploys without errors
- `npm ls react-hotkeys-hook` shows installed
- `grep -n "listArchivedTasks" convex/tasks.ts` shows the new query
  </verify>
  <done>
listArchivedTasks query added to Convex backend and react-hotkeys-hook installed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Archive section and auto-archive hook</name>
  <files>
    src/components/Archive/ArchiveSection.tsx
    src/components/Archive/ArchiveSection.module.css
    src/components/Archive/index.ts
    src/hooks/useAutoArchive.ts
    src/hooks/index.ts
  </files>
  <action>
Create src/hooks/useAutoArchive.ts:
```typescript
import { useEffect, useRef } from "react";
import { useMutation } from "convex/react";
import { api } from "../../convex/_generated/api";
import type { Doc } from "../../convex/_generated/dataModel";

const SEVEN_DAYS_MS = 7 * 24 * 60 * 60 * 1000;

export function useAutoArchive(tasks: Doc<"tasks">[] | undefined) {
  const archiveTask = useMutation(api.tasks.archiveTask);
  const processedRef = useRef<Set<string>>(new Set());

  useEffect(() => {
    if (!tasks) return;

    const now = Date.now();
    const doneTasks = tasks.filter((t) => t.status === "done" && !t.archived);

    doneTasks.forEach((task) => {
      // Check if task has been done for more than 7 days
      const completedAt = task.updatedAt; // Using updatedAt as completion time
      const isOld = now - completedAt > SEVEN_DAYS_MS;

      if (isOld && !processedRef.current.has(task._id)) {
        processedRef.current.add(task._id);
        archiveTask({ id: task._id }).catch((err) => {
          console.error("Failed to auto-archive:", err);
          processedRef.current.delete(task._id);
        });
      }
    });
  }, [tasks, archiveTask]);
}
```

Create src/components/Archive/ArchiveSection.module.css:
```css
.toggle {
  padding: 12px 24px;
  background: var(--bg-secondary);
  border-top: 1px solid var(--border);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  font-size: 13px;
  color: var(--text-muted);
  transition: var(--transition);
  border: none;
  width: 100%;
}

.toggle:hover {
  color: var(--text-secondary);
  background: var(--bg-tertiary);
}

.section {
  padding: 20px 24px;
  background: var(--bg-secondary);
  border-top: 1px solid var(--border);
}

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 12px;
}

.task {
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 12px;
  opacity: 0.7;
  cursor: pointer;
  transition: var(--transition);
}

.task:hover {
  opacity: 1;
  border-color: var(--border-hover);
}

.taskTitle {
  font-size: 13px;
  font-weight: 500;
  color: var(--text-primary);
  margin-bottom: 4px;
}

.taskMeta {
  font-size: 11px;
  color: var(--text-muted);
}

.empty {
  text-align: center;
  color: var(--text-muted);
  font-size: 13px;
  padding: 20px;
}

.restoreHint {
  font-size: 11px;
  color: var(--accent-blue);
  margin-top: 4px;
}
```

Create src/components/Archive/ArchiveSection.tsx:
```typescript
import { useState, useCallback } from "react";
import { useMutation } from "convex/react";
import { toast } from "sonner";
import { api } from "../../../convex/_generated/api";
import type { Doc, Id } from "../../../convex/_generated/dataModel";
import { formatDate } from "@/lib/utils";
import styles from "./ArchiveSection.module.css";

interface ArchiveSectionProps {
  archivedTasks: Doc<"tasks">[];
}

export function ArchiveSection({ archivedTasks }: ArchiveSectionProps) {
  const [isOpen, setIsOpen] = useState(false);
  const restoreTask = useMutation(api.tasks.restoreTask);

  const handleRestore = useCallback(
    async (taskId: Id<"tasks">) => {
      try {
        await restoreTask({ id: taskId });
        toast.success("Task restored to backlog");
      } catch (error) {
        toast.error("Failed to restore task");
        console.error("Failed to restore:", error);
      }
    },
    [restoreTask]
  );

  if (archivedTasks.length === 0) {
    return null;
  }

  return (
    <>
      <button
        className={styles.toggle}
        onClick={() => setIsOpen((prev) => !prev)}
      >
        {isOpen ? "▲ Hide Archive" : `▼ Show Archive (${archivedTasks.length})`}
      </button>

      {isOpen && (
        <div className={styles.section}>
          <div className={styles.grid}>
            {archivedTasks.map((task) => (
              <div
                key={task._id}
                className={styles.task}
                onClick={() => handleRestore(task._id)}
              >
                <div className={styles.taskTitle}>{task.title}</div>
                <div className={styles.taskMeta}>
                  {task.tags.join(", ")} &bull; Archived {formatDate(task.updatedAt)}
                </div>
                <div className={styles.restoreHint}>Click to restore</div>
              </div>
            ))}
          </div>
        </div>
      )}
    </>
  );
}
```

Create src/components/Archive/index.ts:
```typescript
export { ArchiveSection } from "./ArchiveSection";
```

Update src/hooks/index.ts:
```typescript
export { useTaskMutations } from "./useTaskMutations";
export type { TaskUpdates } from "./useTaskMutations";
export { useFilters } from "./useFilters";
export type { FilterState } from "./useFilters";
export { useAutoArchive } from "./useAutoArchive";
```
  </action>
  <verify>
- `npx tsc --noEmit` passes
- `ls src/components/Archive/` shows ArchiveSection.tsx, ArchiveSection.module.css, index.ts
- `ls src/hooks/useAutoArchive.ts` exists
  </verify>
  <done>
Archive section and auto-archive hook created. Component receives archivedTasks as prop from App.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create keyboard shortcuts hook and integrate all in App</name>
  <files>
    src/hooks/useKeyboardShortcuts.ts
    src/hooks/index.ts
    src/App.tsx
  </files>
  <action>
Create src/hooks/useKeyboardShortcuts.ts:
```typescript
import { useHotkeys } from "react-hotkeys-hook";

interface KeyboardShortcutHandlers {
  onEscape?: () => void;
  onNewTask?: () => void;
  onSearch?: () => void;
  onToggleHistory?: () => void;
}

export function useKeyboardShortcuts({
  onEscape,
  onNewTask,
  onSearch,
  onToggleHistory,
}: KeyboardShortcutHandlers) {
  // Escape - close modals/panels
  useHotkeys(
    "escape",
    () => {
      onEscape?.();
    },
    { enableOnFormTags: false }
  );

  // Cmd/Ctrl + N - new task
  useHotkeys(
    "mod+n",
    (e) => {
      e.preventDefault();
      onNewTask?.();
    },
    { enableOnFormTags: false }
  );

  // / or Cmd/Ctrl + K - focus search
  useHotkeys(
    "/, mod+k",
    (e) => {
      e.preventDefault();
      onSearch?.();
    },
    { enableOnFormTags: false }
  );

  // Cmd/Ctrl + H - toggle history
  useHotkeys(
    "mod+h",
    (e) => {
      e.preventDefault();
      onToggleHistory?.();
    },
    { enableOnFormTags: false }
  );
}
```

Update src/hooks/index.ts:
```typescript
export { useTaskMutations } from "./useTaskMutations";
export type { TaskUpdates } from "./useTaskMutations";
export { useFilters } from "./useFilters";
export type { FilterState } from "./useFilters";
export { useAutoArchive } from "./useAutoArchive";
export { useKeyboardShortcuts } from "./useKeyboardShortcuts";
```

Update src/App.tsx to integrate all features:
```typescript
import { useState, useCallback, useRef, useEffect } from "react";
import { useQuery } from "convex/react";
import { api } from "../convex/_generated/api";
import type { Doc } from "../convex/_generated/dataModel";
import { useFilters, useAutoArchive, useKeyboardShortcuts } from "@/hooks";
import { Header } from "@/components/Header";
import { FilterBar } from "@/components/Filters";
import { Board } from "@/components/Board";
import { TaskModal } from "@/components/Task";
import { HistoryPanel } from "@/components/History";
import { ArchiveSection } from "@/components/Archive";
import type { Status } from "@/lib/constants";

function App() {
  const tasks = useQuery(api.tasks.listTasks);
  const archivedTasks = useQuery(api.tasks.listArchivedTasks);

  // Auto-archive old done tasks
  useAutoArchive(tasks);

  // Filter state
  const {
    searchQuery,
    setSearchQuery,
    activeTags,
    toggleTag,
    clearFilters,
    hasActiveFilters,
    filteredTasks,
  } = useFilters(tasks);

  // Modal state
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingTask, setEditingTask] = useState<Doc<"tasks"> | null>(null);
  const [defaultStatus, setDefaultStatus] = useState<Status>("backlog");

  // History panel state
  const [isHistoryOpen, setIsHistoryOpen] = useState(false);

  // Search input ref for focus
  const searchInputRef = useRef<HTMLInputElement>(null);

  const handleAddTask = useCallback((status: Status) => {
    setEditingTask(null);
    setDefaultStatus(status);
    setIsModalOpen(true);
  }, []);

  const handleEditTask = useCallback((taskId: string) => {
    const task = tasks?.find((t) => t._id === taskId);
    if (task) {
      setEditingTask(task);
      setDefaultStatus(task.status as Status);
      setIsModalOpen(true);
    }
  }, [tasks]);

  const handleCloseModal = useCallback(() => {
    setIsModalOpen(false);
    setEditingTask(null);
  }, []);

  const handleShowHistory = useCallback(() => {
    setIsHistoryOpen(true);
  }, []);

  const handleCloseHistory = useCallback(() => {
    setIsHistoryOpen(false);
  }, []);

  // Keyboard shortcuts
  useKeyboardShortcuts({
    onEscape: () => {
      if (isModalOpen) {
        handleCloseModal();
      } else if (isHistoryOpen) {
        handleCloseHistory();
      }
    },
    onNewTask: () => {
      handleAddTask("backlog");
    },
    onSearch: () => {
      // Focus search input
      const searchInput = document.querySelector('input[placeholder*="Search"]') as HTMLInputElement;
      searchInput?.focus();
    },
    onToggleHistory: () => {
      setIsHistoryOpen((prev) => !prev);
    },
  });

  return (
    <main>
      <Header
        taskCount={filteredTasks?.length ?? 0}
        isLoading={tasks === undefined}
        onShowHistory={handleShowHistory}
      />

      <FilterBar
        searchQuery={searchQuery}
        onSearchChange={setSearchQuery}
        activeTags={activeTags}
        onTagToggle={toggleTag}
        onClearFilters={clearFilters}
        hasActiveFilters={hasActiveFilters}
      />

      <Board
        tasks={filteredTasks}
        onAddTask={handleAddTask}
        onEditTask={handleEditTask}
      />

      <ArchiveSection archivedTasks={archivedTasks ?? []} />

      <TaskModal
        isOpen={isModalOpen}
        onClose={handleCloseModal}
        task={editingTask}
        defaultStatus={defaultStatus}
      />

      <HistoryPanel isOpen={isHistoryOpen} onClose={handleCloseHistory} />
    </main>
  );
}

export default App;
```
  </action>
  <verify>
- `npm run dev` - archive section shows at bottom with count
- Click to expand archive, click task to restore
- Cmd+N opens new task modal
- / or Cmd+K focuses search
- Cmd+H toggles history panel
- Escape closes modal or panel
- `npx tsc --noEmit` passes
  </verify>
  <done>
Keyboard shortcuts and archive section fully integrated with Convex query.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete React frontend with full feature parity to vanilla app:
- 4-column Kanban board with tasks from Convex
- Drag-and-drop between columns with optimistic updates
- Task create/edit/delete via modal
- Search and tag filtering
- Activity history panel
- Auto-archive of old done tasks
- Archive section with restore
- Toast notifications
- Keyboard shortcuts (Cmd+N, /, Cmd+H, Escape, Cmd+Enter)
  </what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`
2. Open browser to localhost:5173

**Test each feature:**

a) **Board display:**
   - 4 columns visible: Backlog, In Progress, Blocked, Done
   - Tasks show priority color, title, tags, due date

b) **Drag and drop:**
   - Drag a task between columns
   - Should move instantly (no waiting)
   - Refresh page - task should persist in new column

c) **Create task:**
   - Click "Add Task" on any column
   - Fill form: title, description, priority, tags, due date
   - Click Save or Cmd+Enter
   - Toast shows "Task created"

d) **Edit task:**
   - Click "..." menu on any task
   - Modal shows with existing data
   - Change fields, save
   - Toast shows "Task updated"

e) **Delete task:**
   - Edit a task, click Delete
   - Toast shows "Task deleted"
   - Task disappears (archived)

f) **Search and filter:**
   - Type in search box - tasks filter in real-time
   - Click tag chips - filter by tag (OR logic: any matching tag)
   - Click "All" to reset

g) **History:**
   - Click "History" button
   - Panel slides in from right
   - Shows recent actions with timestamps
   - Click X or outside to close

h) **Archive:**
   - If any archived tasks exist, click "Show Archive"
   - Click task to restore to backlog
   - Toast shows "Task restored"

i) **Keyboard shortcuts:**
   - Cmd+N: Opens new task modal
   - /: Focuses search box
   - Cmd+H: Toggles history panel
   - Escape: Closes modal/panel
   - Cmd+Enter: Saves task in modal

**Expected:** All features work as described, matching original vanilla app behavior.
  </how-to-verify>
  <resume-signal>Type "approved" if all features work, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. Archive section shows archived task count
2. Archive expands to show tasks with restore option
3. Auto-archive runs on old done tasks (7+ days)
4. Keyboard shortcuts work globally
5. Full feature parity with vanilla app achieved
6. User has verified functionality
</verification>

<success_criteria>
- Archive section with toggle and restore
- Auto-archive for old done tasks
- Keyboard shortcuts: Cmd+N, /, Cmd+H, Escape
- Human verification passes
- Full feature parity confirmed
</success_criteria>

<output>
After completion, create `.planning/phases/02-react-frontend/02-07-SUMMARY.md`
</output>
