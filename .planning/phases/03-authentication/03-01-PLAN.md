---
phase: 03-authentication
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/auth.ts
  - convex/auth.config.ts
  - convex/http.ts
  - convex/schema.ts
autonomous: true
user_setup:
  - service: google-oauth
    why: "Google OAuth requires credentials from Google Cloud Console"
    env_vars:
      - name: AUTH_GOOGLE_ID
        source: "Google Cloud Console -> APIs & Services -> Credentials -> OAuth 2.0 Client ID"
      - name: AUTH_GOOGLE_SECRET
        source: "Google Cloud Console -> APIs & Services -> Credentials -> OAuth 2.0 Client Secret"
    dashboard_config:
      - task: "Create OAuth 2.0 Client ID (Web application type)"
        location: "Google Cloud Console -> APIs & Services -> Credentials"
      - task: "Add authorized redirect URI: https://[deployment].convex.site/api/auth/callback/google"
        location: "Google Cloud Console -> OAuth Client -> Authorized redirect URIs"
  - service: convex
    why: "Convex Auth requires environment variables"
    env_vars:
      - name: SITE_URL
        source: "Your Vercel deployment URL (e.g., https://loom-board.vercel.app)"
      - name: CONVEX_SITE_URL
        source: "Convex dashboard -> Deployment Settings -> HTTP Actions URL"

must_haves:
  truths:
    - "Auth tables exist in Convex database (users, authSessions, authAccounts, etc.)"
    - "HTTP routes respond at /api/auth/* paths"
    - "Schema includes userId field on tasks table"
  artifacts:
    - path: "convex/auth.ts"
      provides: "Google OAuth provider configuration with 30-day sessions"
      contains: "Google"
    - path: "convex/auth.config.ts"
      provides: "Auth domain configuration"
      exports: ["default"]
    - path: "convex/http.ts"
      provides: "HTTP routes for auth callbacks"
      contains: "httpRouter"
    - path: "convex/schema.ts"
      provides: "Auth tables + userId on tasks"
      contains: "authTables"
  key_links:
    - from: "convex/auth.ts"
      to: "@convex-dev/auth"
      via: "convexAuth import"
      pattern: "convexAuth"
    - from: "convex/http.ts"
      to: "convex/auth.ts"
      via: "auth.addHttpRoutes"
      pattern: "auth\\.addHttpRoutes"
---

<objective>
Set up Convex Auth backend with Google OAuth provider

Purpose: Establishes the authentication infrastructure that all subsequent plans depend on. Without auth backend, frontend cannot authenticate users.
Output: Working Convex Auth configuration with Google provider, HTTP routes, and schema with auth tables + userId on tasks
</objective>

<execution_context>
@/Users/criswo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/criswo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-authentication/03-RESEARCH.md
@.planning/phases/03-authentication/03-CONTEXT.md
@convex/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Convex Auth dependencies and create auth configuration</name>
  <files>
    package.json
    convex/auth.ts
    convex/auth.config.ts
    convex/http.ts
  </files>
  <action>
1. Install dependencies:
   ```bash
   npm install @convex-dev/auth @auth/core@~0.37.3
   ```
   Pin @auth/core to ~0.37.3 (not latest) - required for @convex-dev/auth@0.0.90 compatibility per RESEARCH.md pitfall.

2. Create `convex/auth.config.ts`:
   ```typescript
   export default {
     providers: [],
   };
   ```
   This minimal config is required - providers are configured in auth.ts.

3. Create `convex/auth.ts` with Google provider and 30-day session:
   ```typescript
   import Google from "@auth/core/providers/google";
   import { convexAuth } from "@convex-dev/auth/server";

   export const { auth, signIn, signOut, store } = convexAuth({
     providers: [Google],
     session: {
       totalDurationMs: 30 * 24 * 60 * 60 * 1000, // 30 days per CONTEXT.md
     },
   });
   ```

4. Create `convex/http.ts` to expose auth routes:
   ```typescript
   import { httpRouter } from "convex/server";
   import { auth } from "./auth";

   const http = httpRouter();
   auth.addHttpRoutes(http);

   export default http;
   ```

Do NOT run `npx @convex-dev/auth` interactive setup - manual setup gives more control and avoids prompts.
  </action>
  <verify>
    - `npm ls @convex-dev/auth` shows installed
    - `npm ls @auth/core` shows ~0.37.x version
    - Files exist: convex/auth.ts, convex/auth.config.ts, convex/http.ts
    - `npx convex dev --once` compiles without errors
  </verify>
  <done>
    - @convex-dev/auth and @auth/core installed
    - Auth configuration files created with Google provider
    - HTTP router configured with auth routes
    - Convex compiles successfully
  </done>
</task>

<task type="auto">
  <name>Task 2: Update schema with authTables and add userId to tasks</name>
  <files>convex/schema.ts</files>
  <action>
1. Update `convex/schema.ts` to spread authTables and add userId to tasks:
   ```typescript
   import { defineSchema, defineTable } from "convex/server";
   import { v } from "convex/values";
   import { authTables } from "@convex-dev/auth/server";

   // ... existing validators ...

   export default defineSchema({
     ...authTables,  // Spreads users, authSessions, authAccounts, etc.

     tasks: defineTable({
       // ... existing fields ...
       userId: v.id("users"),  // NEW: owner of the task
     })
       .index("by_status_order", ["status", "order"])
       .index("by_priority", ["priority"])
       .index("by_dueDate", ["dueDate"])
       .index("by_archived", ["archived"])
       .index("by_user", ["userId"]),  // NEW: query tasks by owner

     activity_history: defineTable({
       // ... existing fields ...
       // userId already optional (v.optional(v.string())) - will be populated with real user ID
     })
       .index("by_task", ["taskId"]),
   });
   ```

2. Key changes:
   - Import and spread `authTables` from @convex-dev/auth/server
   - Add `userId: v.id("users")` to tasks (required, not optional - all tasks must have owner)
   - Add `by_user` index for efficient user-scoped queries

Note: This is a schema migration. Existing tasks will need userId populated. For now, the schema is prepared. Plan 02 will handle function updates, and Phase 5 (Migration) will backfill existing data.
  </action>
  <verify>
    - `npx convex dev --once` compiles and pushes schema
    - Convex dashboard shows new tables: users, authSessions, authAccounts, authRefreshTokens, authVerificationCodes, authVerifiers, authRateLimits
    - tasks table shows userId field and by_user index in dashboard
  </verify>
  <done>
    - Schema includes authTables (7 new tables)
    - tasks table has userId field with by_user index
    - Schema deployed to Convex
  </done>
</task>

</tasks>

<verification>
1. Run `npx convex dev --once` - should compile and deploy
2. Check Convex dashboard -> Data -> Tables list should include auth tables
3. Check Convex dashboard -> Data -> tasks schema shows userId field
4. HTTP Actions URL should exist (needed for callback URL)
</verification>

<success_criteria>
- All auth-related files exist and compile
- Convex dashboard shows authTables (users, authSessions, etc.)
- tasks schema includes userId: Id<"users"> and by_user index
- No TypeScript or Convex errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-authentication/03-01-SUMMARY.md`
</output>
