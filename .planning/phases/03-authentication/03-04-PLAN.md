---
phase: 03-authentication
plan: 04
type: execute
wave: 3
depends_on: ["03-02", "03-03"]
files_modified:
  - src/components/Header/Header.tsx
  - src/components/Header/Header.module.css
  - convex/users.ts
autonomous: false

must_haves:
  truths:
    - "User can sign out and is returned to login screen"
    - "User identity (avatar + name) shown in header"
    - "Hardcoded password removed from codebase"
    - "Fake password gate UI removed"
  artifacts:
    - path: "src/components/Header/Header.tsx"
      provides: "User avatar, name, and sign out button"
      contains: "signOut"
    - path: "convex/users.ts"
      provides: "Query to get current user profile"
      exports: ["getCurrentUser"]
  key_links:
    - from: "src/components/Header/Header.tsx"
      to: "@convex-dev/auth/react"
      via: "useAuthActions for signOut"
      pattern: "useAuthActions"
    - from: "src/components/Header/Header.tsx"
      to: "convex/users.ts"
      via: "useQuery(api.users.getCurrentUser)"
      pattern: "getCurrentUser"
---

<objective>
Add user display in header, sign out functionality, and cleanup legacy auth code

Purpose: Implements AUTH-03 (sign out), completes the user experience from CONTEXT.md (avatar + name in header), and satisfies SEC-01/SEC-02 (remove hardcoded password and fake gate).
Output: Header shows user avatar and name, sign out button works, legacy auth code removed
</objective>

<execution_context>
@/Users/criswo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/criswo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-authentication/03-RESEARCH.md
@.planning/phases/03-authentication/03-CONTEXT.md
@.planning/phases/03-authentication/03-02-SUMMARY.md
@.planning/phases/03-authentication/03-03-SUMMARY.md
@src/components/Header/Header.tsx
@src/components/Header/Header.module.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create user query and update Header with user display</name>
  <files>
    convex/users.ts
    src/components/Header/Header.tsx
    src/components/Header/Header.module.css
  </files>
  <action>
1. Create `convex/users.ts` to query current user profile:
   ```typescript
   import { query } from "./_generated/server";
   import { getAuthUserId } from "@convex-dev/auth/server";

   export const getCurrentUser = query({
     args: {},
     handler: async (ctx) => {
       const userId = await getAuthUserId(ctx);
       if (!userId) return null;

       const user = await ctx.db.get(userId);
       return user;
     },
   });
   ```

2. Update `src/components/Header/Header.module.css` to add user display styles:
   ```css
   /* Add to existing styles */

   .userSection {
     display: flex;
     align-items: center;
     gap: 0.75rem;
   }

   .userInfo {
     display: flex;
     align-items: center;
     gap: 0.5rem;
   }

   .avatar {
     width: 32px;
     height: 32px;
     border-radius: 50%;
     object-fit: cover;
     border: 2px solid var(--border);
   }

   .avatarPlaceholder {
     width: 32px;
     height: 32px;
     border-radius: 50%;
     background: var(--bg-tertiary);
     display: flex;
     align-items: center;
     justify-content: center;
     font-size: 0.875rem;
     font-weight: 600;
     color: var(--text-secondary);
     border: 2px solid var(--border);
   }

   .userName {
     font-size: 0.875rem;
     color: var(--text-secondary);
     max-width: 150px;
     overflow: hidden;
     text-overflow: ellipsis;
     white-space: nowrap;
   }

   .signOutBtn {
     padding: 0.5rem 0.75rem;
     background: transparent;
     border: 1px solid var(--border);
     border-radius: 6px;
     color: var(--text-secondary);
     font-size: 0.8125rem;
     cursor: pointer;
     transition: background 0.2s, color 0.2s;
   }

   .signOutBtn:hover {
     background: var(--bg-tertiary);
     color: var(--text-primary);
   }

   /* Hide username on small screens */
   @media (max-width: 640px) {
     .userName {
       display: none;
     }
   }
   ```

3. Update `src/components/Header/Header.tsx` to display user and sign out:
   ```typescript
   import { useQuery } from "convex/react";
   import { useAuthActions } from "@convex-dev/auth/react";
   import { api } from "../../../convex/_generated/api";
   import styles from "./Header.module.css";

   interface HeaderProps {
     taskCount: number;
     isLoading: boolean;
     onShowHistory?: () => void;
   }

   export function Header({ taskCount, isLoading, onShowHistory }: HeaderProps) {
     const user = useQuery(api.users.getCurrentUser);
     const { signOut } = useAuthActions();

     const handleSignOut = async () => {
       await signOut();
       // Redirect to login happens automatically via Unauthenticated component
     };

     // Get initials for avatar placeholder
     const getInitials = (name: string | undefined) => {
       if (!name) return "?";
       return name
         .split(" ")
         .map((n) => n[0])
         .join("")
         .toUpperCase()
         .slice(0, 2);
     };

     return (
       <header className={styles.header}>
         <div className={styles.content}>
           <div className={styles.left}>
             <h1 className={styles.title}>Loom Board</h1>
             <span className={styles.statusBadge}>
               <span className={styles.statusDot} />
               Active
             </span>
           </div>
           <div className={styles.right}>
             <button className={styles.btn} onClick={onShowHistory}>
               &#x1F4CB; History
             </button>
             <span className={styles.taskCount}>
               {isLoading ? "Loading..." : `${taskCount} task${taskCount === 1 ? "" : "s"}`}
             </span>

             {/* User section */}
             <div className={styles.userSection}>
               <div className={styles.userInfo}>
                 {user?.image ? (
                   <img
                     src={user.image}
                     alt={user.name || "User"}
                     className={styles.avatar}
                   />
                 ) : (
                   <div className={styles.avatarPlaceholder}>
                     {getInitials(user?.name)}
                   </div>
                 )}
                 {user?.name && (
                   <span className={styles.userName}>{user.name}</span>
                 )}
               </div>
               <button
                 className={styles.signOutBtn}
                 onClick={handleSignOut}
               >
                 Sign out
               </button>
             </div>
           </div>
         </div>
       </header>
     );
   }
   ```

Per CONTEXT.md: User identity shown in header with avatar + name from Google profile.
  </action>
  <verify>
    - `npx convex dev --once` compiles users.ts
    - `npm run dev` starts without errors
    - When authenticated: Header shows user avatar (or initials), name, and sign out button
    - Click sign out: redirects to login screen
  </verify>
  <done>
    - getCurrentUser query returns user profile from Convex Auth
    - Header displays user avatar (from Google) or initials placeholder
    - Header displays user name
    - Sign out button calls signOut() and redirects to login
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove hardcoded password and fake gate</name>
  <files>TBD - search codebase</files>
  <action>
1. Search for legacy auth code:
   ```bash
   # Search for hardcoded password
   grep -r "loom2026" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.html" .

   # Search for sessionStorage auth
   grep -r "loom-auth" --include="*.ts" --include="*.tsx" --include="*.js" .

   # Search for password-related UI
   grep -r "password" --include="*.ts" --include="*.tsx" .
   ```

2. For each file found:
   - If it's the old vanilla JS HTML file: delete it entirely (we have React now)
   - If it's React code with auth checks: remove the fake auth logic
   - If it's a password input UI: remove the component/code

3. Verify no references remain:
   ```bash
   grep -r "loom2026\|loom-auth\|sessionStorage.*auth" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.html" .
   ```

SEC-01: Remove hardcoded password from source code
SEC-02: Remove fake password gate UI

Note: The original app was a single HTML file that has been replaced by React. If index.html or any legacy files contain the old password gate, they should be cleaned up or removed.
  </action>
  <verify>
    - `grep -r "loom2026" .` returns no results
    - `grep -r "loom-auth" .` returns no results
    - No password input fields in the codebase
    - `npm run build` succeeds
  </verify>
  <done>
    - Hardcoded password "loom2026" removed from codebase
    - sessionStorage "loom-auth" checks removed
    - Fake password gate UI removed
    - Build passes
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Google OAuth authentication flow:
    - Login screen with Google sign-in button
    - Protected board (only visible when authenticated)
    - User avatar and name in header
    - Sign out functionality
    - All task data scoped to authenticated user
  </what-built>
  <how-to-verify>
    1. Open app at http://localhost:5173 (or your dev URL)
    2. Verify: Login screen shows with Google button (no board visible)
    3. Click "Continue with Google" and complete OAuth flow
    4. Verify: After sign-in, board is visible
    5. Verify: Header shows your Google avatar and name
    6. Create a test task
    7. Click "Sign out" button in header
    8. Verify: Redirected to login screen
    9. Sign in again
    10. Verify: Your test task is still there (persisted to your account)
    11. Open browser DevTools -> Application -> Local Storage
    12. Verify: No "loom-auth" key exists

    Note: If OAuth fails with "redirect_uri_mismatch", ensure:
    - Google Cloud Console has correct callback URL configured
    - SITE_URL and AUTH_GOOGLE_* env vars are set in Convex dashboard
  </how-to-verify>
  <resume-signal>Type "approved" if auth flow works correctly, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. User can sign in with Google (AUTH-01)
2. Session persists across refresh (AUTH-02) - refresh page while signed in
3. User can sign out (AUTH-03) - click sign out, see login screen
4. Loading state shown during auth check (AUTH-05) - brief spinner on refresh
5. No hardcoded password in codebase (SEC-01)
6. No fake password gate (SEC-02)
7. All Convex functions validate auth (SEC-03) - verified in Plan 02
</verification>

<success_criteria>
- Full OAuth flow works: login screen -> Google -> board
- User avatar and name displayed in header
- Sign out returns to login screen
- Session persists across page refresh
- No legacy auth code (grep confirms)
- Build and lint pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-authentication/03-04-SUMMARY.md`
</output>
