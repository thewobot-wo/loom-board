---
phase: 05-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/migration.ts
  - convex/migration.ts
autonomous: true

must_haves:
  truths:
    - "localStorage data with v1.0 format can be read and validated"
    - "Valid tasks are transformed to match Convex schema (status, priority, tags, dueDate mappings)"
    - "Invalid or archived tasks are filtered out"
    - "Authenticated user can batch-insert transformed tasks into Convex"
    - "Each migrated task gets a migration activity history entry"
  artifacts:
    - path: "src/lib/migration.ts"
      provides: "localStorage reading, v1.0 validation, data transformation utilities"
      exports: ["readLocalStorageTasks", "isValidV1Task", "transformTask", "hasMigrated", "markMigrated"]
      min_lines: 60
    - path: "convex/migration.ts"
      provides: "Convex mutation for batch task insertion with auth"
      exports: ["migrateLocalTasks"]
      min_lines: 30
  key_links:
    - from: "src/lib/migration.ts"
      to: "convex/schema.ts"
      via: "STATUS_MAP and PRIORITY_MAP produce values matching statusValidator and priorityValidator"
      pattern: "(in_progress|backlog|blocked|done).*(urgent|high|medium|low)"
    - from: "convex/migration.ts"
      to: "convex/schema.ts"
      via: "inserts into tasks and activity_history tables"
      pattern: "ctx\\.db\\.insert\\(\"tasks\""
---

<objective>
Create the migration data layer: client-side utilities for reading/validating/transforming localStorage v1.0 task data, and a Convex mutation for batch-inserting transformed tasks with authentication and activity history.

Purpose: This is the foundation for the migration feature. The client-side utils handle all the schema differences between v1.0 (hyphen statuses, p0-p3 priorities, singular tag, date strings) and the current Convex schema (underscore statuses, named priorities, tags array, timestamp numbers). The server mutation handles authenticated batch insertion.

Output: Two files -- `src/lib/migration.ts` (client utils) and `convex/migration.ts` (server mutation)
</objective>

<execution_context>
@/Users/criswo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/criswo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-migration/05-RESEARCH.md

@convex/schema.ts
@convex/tasks.ts
@src/lib/constants.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create client-side migration utilities</name>
  <files>src/lib/migration.ts</files>
  <action>
Create `src/lib/migration.ts` with the following exports:

**Types:**
- `LocalStorageTask` interface matching v1.0 format: id (string), title (string), description (optional string), status (string -- "backlog" | "in-progress" | "blocked" | "done"), priority (string -- "p0" | "p1" | "p2" | "p3"), tag (string -- singular), dueDate (optional string -- "YYYY-MM-DD"), createdAt (optional number), archived (optional boolean), blockedReason (optional string | null), startedAt (optional number), completedAt (optional number), blockedSince (optional number)

**Constants:**
- `LOOM_TASKS_KEY = "loom-tasks"` -- the localStorage key used by v1.0
- `MIGRATION_FLAG_KEY = "loom-migration-complete"` -- flag to prevent re-prompting
- `STATUS_MAP`: `{ "backlog": "backlog", "in-progress": "in_progress", "blocked": "blocked", "done": "done" }`
- `PRIORITY_MAP`: `{ "p0": "urgent", "p1": "high", "p2": "medium", "p3": "low" }`
- `VALID_OLD_STATUSES = ["backlog", "in-progress", "blocked", "done"]`

**Functions:**
- `readLocalStorageTasks(): LocalStorageTask[] | null` -- reads `loom-tasks` key, parses JSON, validates it has a `tasks` array, returns the array or null on any failure. Wraps in try/catch for malformed JSON.
- `isValidV1Task(task: unknown): task is LocalStorageTask` -- type guard that checks: task is non-null object, has string `id`, has non-empty string `title`, has string `status` in VALID_OLD_STATUSES. Optional fields checked for correct types if present.
- `transformTask(task: LocalStorageTask, order: number)` -- returns object matching Convex schema: title, description (undefined if empty string), status via STATUS_MAP (fallback "backlog"), priority via PRIORITY_MAP (fallback "medium"), tags as `task.tag ? [task.tag] : []`, dueDate as `new Date(task.dueDate).getTime()` if valid (check for NaN, skip if invalid), order, createdAt (task.createdAt or Date.now()), updatedAt (task.createdAt or Date.now() -- preserves relative ordering per RESEARCH.md).
- `hasMigrated(): boolean` -- checks localStorage for MIGRATION_FLAG_KEY === "true"
- `markMigrated(): void` -- sets MIGRATION_FLAG_KEY to "true" in localStorage
- `clearLocalStorageTasks(): void` -- removes LOOM_TASKS_KEY from localStorage

Do NOT import from convex or any server-side modules -- this is pure client-side utility code.
  </action>
  <verify>
Run `npx tsc --noEmit` from project root to verify TypeScript compilation succeeds with no errors in `src/lib/migration.ts`.
  </verify>
  <done>
All 6 functions exported, STATUS_MAP maps all 4 statuses correctly, PRIORITY_MAP maps all 4 priorities correctly, isValidV1Task validates required fields, transformTask handles all schema differences (status hyphen->underscore, priority p0->urgent, tag->tags array, dueDate string->number).
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Convex migration mutation</name>
  <files>convex/migration.ts</files>
  <action>
Create `convex/migration.ts` with a single exported mutation:

**`migrateLocalTasks` mutation:**
- Args: `tasks` as `v.array(v.object({...}))` where the object shape matches what `transformTask` returns: title (v.string()), description (v.optional(v.string())), status (v.string()), priority (v.string()), tags (v.array(v.string())), dueDate (v.optional(v.number())), order (v.number()), createdAt (v.number()), updatedAt (v.number())
- Handler:
  1. Get authenticated user with `getAuthUserId(ctx)` from `@convex-dev/auth/server`. Throw "Not authenticated" if null.
  2. Loop over args.tasks. For each task:
     a. Insert into "tasks" table with all fields plus `archived: false`, `userId` set to the authenticated user's ID. Cast status and priority to the schema types (they've already been mapped client-side).
     b. Insert into "activity_history" table: taskId (the new ID), field "_migrated", oldValue undefined, newValue as `JSON.stringify({ source: "localStorage", title: task.title })`, userId as `userId.toString()` (matches existing pattern in activityHistory.ts where userId is stored as string)
  3. Return `{ imported: results.length }` where results is the array of inserted task IDs

Use the same import pattern as tasks.ts: `import { mutation } from "./_generated/server"` and `import { v } from "convex/values"`.

Note: Use `as any` for status/priority casting to satisfy TypeScript since the mutation args use v.string() but the schema expects the union validators. The values are guaranteed correct because they come from the client-side STATUS_MAP/PRIORITY_MAP.
  </action>
  <verify>
Run `npx convex dev --once` (or check that `npx tsc --noEmit -p convex/tsconfig.json` passes). Verify the mutation appears in the Convex dashboard functions list.
  </verify>
  <done>
`migrateLocalTasks` mutation exists in convex/migration.ts, authenticates via getAuthUserId, accepts pre-transformed task array, inserts tasks with userId, creates activity history entries with "_migrated" field, returns count of imported tasks.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes -- both files compile without errors
2. `src/lib/migration.ts` exports all 6 functions and 2 type/interface exports
3. `convex/migration.ts` exports `migrateLocalTasks` mutation
4. STATUS_MAP covers all 4 v1.0 statuses with correct Convex mappings
5. PRIORITY_MAP covers all 4 v1.0 priorities with correct Convex mappings
6. transformTask handles NaN dueDate by producing undefined
</verification>

<success_criteria>
- Client-side migration utilities compile and export correct types
- Convex mutation compiles and is deployable
- Data transformation correctly maps all schema differences between v1.0 and current Convex schema
- Authentication enforced on mutation
- Activity history created for each migrated task
</success_criteria>

<output>
After completion, create `.planning/phases/05-migration/05-01-SUMMARY.md`
</output>
