---
phase: 05-migration
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/components/Migration/MigrationModal.tsx
  - src/components/Migration/MigrationModal.module.css
  - src/components/Migration/index.ts
  - src/App.tsx
autonomous: false

must_haves:
  truths:
    - "User with localStorage data sees migration modal on first authenticated login"
    - "Modal shows task count and offers Migrate or Skip buttons"
    - "Clicking Migrate imports tasks and shows success toast with count"
    - "Clicking Skip sets flag so prompt never returns"
    - "After migration, localStorage task data is cleared"
    - "Modal shows loading state during import"
    - "Malformed tasks are skipped with count reported in toast"
    - "Empty localStorage shows no migration prompt"
  artifacts:
    - path: "src/components/Migration/MigrationModal.tsx"
      provides: "Migration prompt modal with migrate/skip actions"
      min_lines: 60
    - path: "src/components/Migration/MigrationModal.module.css"
      provides: "Modal styling matching TaskModal pattern"
      min_lines: 20
    - path: "src/components/Migration/index.ts"
      provides: "Barrel export for MigrationModal"
    - path: "src/App.tsx"
      provides: "MigrationModal wired into BoardContent with auto-detection"
      contains: "MigrationModal"
  key_links:
    - from: "src/App.tsx"
      to: "src/components/Migration/MigrationModal.tsx"
      via: "import and conditional render in BoardContent"
      pattern: "showMigration.*MigrationModal"
    - from: "src/components/Migration/MigrationModal.tsx"
      to: "src/lib/migration.ts"
      via: "import readLocalStorageTasks, isValidV1Task, transformTask, markMigrated, clearLocalStorageTasks"
      pattern: "import.*from.*lib/migration"
    - from: "src/components/Migration/MigrationModal.tsx"
      to: "convex/migration.ts"
      via: "useMutation(api.migration.migrateLocalTasks)"
      pattern: "useMutation.*migration\\.migrateLocalTasks"
    - from: "src/App.tsx"
      to: "src/lib/migration.ts"
      via: "import hasMigrated, readLocalStorageTasks, markMigrated for auto-detection"
      pattern: "import.*hasMigrated.*from.*lib/migration"
---

<objective>
Create the MigrationModal component and wire it into the app so that returning users with localStorage data see a migration prompt on first authenticated login.

Purpose: This completes the migration feature. The modal reads localStorage, shows a preview count, lets the user migrate or skip, handles the actual import via the Convex mutation, shows progress/results, and cleans up afterward.

Output: Migration component directory (MigrationModal.tsx, CSS module, barrel export) and modified App.tsx with auto-detection logic.
</objective>

<execution_context>
@/Users/criswo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/criswo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-migration/05-RESEARCH.md
@.planning/phases/05-migration/05-01-SUMMARY.md

@src/App.tsx
@src/components/Task/TaskModal.tsx
@src/components/Task/TaskModal.module.css
@src/lib/migration.ts
@convex/migration.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MigrationModal component with styling</name>
  <files>
    src/components/Migration/MigrationModal.tsx
    src/components/Migration/MigrationModal.module.css
    src/components/Migration/index.ts
  </files>
  <action>
**Create `src/components/Migration/index.ts`:**
Barrel export: `export { MigrationModal } from "./MigrationModal";`

**Create `src/components/Migration/MigrationModal.module.css`:**
Follow the same pattern as TaskModal.module.css (overlay, modal container, header, body, footer). Key styles:
- `.overlay`: fixed position, full viewport, semi-transparent dark background, z-index 1000, flex centering
- `.modal`: dark background (var(--bg-secondary) or similar), border radius, max-width ~480px, padding, border with var(--border)
- `.header`: modal title "Migrate Local Data" with appropriate styling
- `.body`: padding, text content area for the migration description and task count
- `.taskCount`: highlighted number styling (larger font or accent color for the count)
- `.footer`: flex row with gap, justify-end for buttons
- `.btnMigrate`: accent/primary colored button (similar to save/submit buttons in TaskModal)
- `.btnSkip`: secondary/ghost button style
- `.loading`: loading state styling with reduced opacity on buttons, cursor wait
- `.progressText`: text showing "Importing..." status

**Create `src/components/Migration/MigrationModal.tsx`:**
Props: `onComplete: () => void`, `onSkip: () => void`

Component logic:
1. On mount, read localStorage tasks using `readLocalStorageTasks()` from `@/lib/migration`
2. Filter to active (non-archived) tasks, then validate each with `isValidV1Task`
3. Store counts: `totalActive` (active tasks before validation), `validCount` (tasks passing validation)
4. State: `isMigrating: boolean` (loading state)

Render:
- Overlay div (clicking overlay does nothing -- user must choose Migrate or Skip)
- Modal container with:
  - Header: "Migrate Local Data"
  - Body:
    - If validCount > 0: "Found **{validCount} tasks** in your browser storage. Would you like to import them to your account?"
    - If validCount === 0 but raw data existed: "No valid tasks found in browser storage." with only a Close/Continue button
  - Footer:
    - "Skip" button (secondary style) -- calls `onSkip` (which calls markMigrated + closes modal in parent)
    - "Migrate {validCount} Tasks" button (primary style) -- triggers handleMigrate
  - During migration: both buttons disabled, body shows "Importing tasks..." text

**handleMigrate function:**
1. Set `isMigrating(true)`
2. Get raw tasks via `readLocalStorageTasks()`, filter active + valid, transform each with `transformTask(task, index)`
3. Call `migrateLocalTasks({ tasks: transformedTasks })` via `useMutation(api.migration.migrateLocalTasks)`
4. On success:
   - If skipped tasks exist (totalActive - validCount > 0): `toast.success("Imported {result.imported} of {totalActive} tasks")`
   - Else: `toast.success("Imported {result.imported} tasks successfully")`
   - Call `clearLocalStorageTasks()` to remove localStorage data
   - Call `markMigrated()` to set the flag
   - Call `onComplete()` to close modal
5. On error:
   - `toast.error("Migration failed. Please try again.")`
   - Set `isMigrating(false)` so user can retry

Import `useMutation` from `convex/react`, `api` from the generated API, `toast` from `sonner`, and migration utils from `@/lib/migration`.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify all three files compile. Check that MigrationModal is exported from the barrel.
  </verify>
  <done>
MigrationModal renders with task count preview, Migrate button triggers batch import via Convex mutation, Skip button sets flag, loading state disables buttons during import, success/error toasts shown, localStorage cleared after success.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire MigrationModal into BoardContent</name>
  <files>src/App.tsx</files>
  <action>
Modify `src/App.tsx` to integrate the migration flow:

1. Add imports at top:
   - `import { MigrationModal } from "@/components/Migration";`
   - `import { hasMigrated, readLocalStorageTasks, markMigrated } from "@/lib/migration";`
   - Add `useEffect` to the existing React import if not already there

2. Inside `BoardContent` function, add state:
   - `const [showMigration, setShowMigration] = useState(false);`

3. Add useEffect for auto-detection (run once on mount):
   ```
   useEffect(() => {
     if (!hasMigrated()) {
       const tasks = readLocalStorageTasks();
       if (tasks && tasks.filter(t => !t.archived).length > 0) {
         setShowMigration(true);
       } else {
         markMigrated(); // No data to migrate, prevent future checks
       }
     }
   }, []);
   ```

4. In the JSX return, add MigrationModal as the first child inside `<main>`:
   ```
   {showMigration && (
     <MigrationModal
       onComplete={() => setShowMigration(false)}
       onSkip={() => {
         markMigrated();
         setShowMigration(false);
       }}
     />
   )}
   ```

Keep all existing BoardContent code unchanged. The MigrationModal renders as an overlay on top of the board.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify App.tsx compiles. Run `npm run dev` and verify the app loads without errors in browser console (if no localStorage data exists, migration modal should NOT appear).
  </verify>
  <done>
BoardContent auto-detects localStorage data on mount, shows MigrationModal when data exists and migration hasn't been done, MigrationModal overlay renders on top of board, Skip marks as migrated and closes, Migrate imports and closes on success.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete localStorage-to-Convex migration flow: auto-detection on login, migration modal with task count preview, batch import with schema transformation (status, priority, tags, dueDate mappings), success/error toasts, localStorage cleanup, one-chance skip.</what-built>
  <how-to-verify>
1. To test WITH localStorage data: Open browser DevTools console and run:
   ```
   localStorage.setItem('loom-tasks', JSON.stringify({ tasks: [
     { id: "test-1", title: "Test Task 1", status: "in-progress", priority: "p0", tag: "project", createdAt: Date.now() - 86400000 },
     { id: "test-2", title: "Test Task 2", status: "backlog", priority: "p2", tag: "research", dueDate: "2026-03-01", createdAt: Date.now() - 172800000 },
     { id: "test-3", title: "Archived Task", status: "done", priority: "p3", tag: "bug", archived: true, createdAt: Date.now() - 259200000 }
   ], history: [] }));
   localStorage.removeItem('loom-migration-complete');
   ```
   Then refresh the page.
2. Verify: Migration modal appears showing "Found 2 tasks in your browser" (archived task excluded)
3. Click "Migrate 2 Tasks" -- verify loading state, then success toast
4. Verify: Tasks appear on the board with correct columns (Test Task 1 in "In Progress", Test Task 2 in "Backlog")
5. Verify: Priority mapped correctly (p0 -> urgent, p2 -> medium)
6. Verify: Tags mapped correctly (singular "project" -> ["project"])
7. Refresh page -- verify migration modal does NOT reappear
8. Check localStorage -- `loom-tasks` key should be removed, `loom-migration-complete` should be "true"

To test Skip:
1. Re-add test data (step 1 above), remove migration flag
2. Refresh, click "Skip"
3. Verify: Modal closes, no tasks imported, refreshing does NOT show modal again
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes for entire project
2. App loads without console errors
3. Migration modal appears only when localStorage has active task data AND migration flag is not set
4. Migrate imports tasks with correct schema mappings
5. Skip sets flag and never shows modal again
6. localStorage cleaned up after successful migration
7. Activity history entries created for each migrated task (check Convex dashboard)
</verification>

<success_criteria>
- User with v1.0 localStorage data sees migration prompt on first authenticated login
- Migration imports active, valid tasks with all field mappings correct
- Archived tasks excluded from migration
- Malformed tasks skipped with count in toast
- Skip prevents future prompts (one-chance only)
- localStorage task data cleared after successful migration
- Activity history records migration event per task
</success_criteria>

<output>
After completion, create `.planning/phases/05-migration/05-02-SUMMARY.md`
</output>
