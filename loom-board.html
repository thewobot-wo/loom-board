<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loom Board</title>
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --border: #30363d;
            --border-hover: #58a6ff;
            --text-primary: #f0f6fc;
            --text-secondary: #c9d1d9;
            --text-muted: #8b949e;
            --accent-blue: #58a6ff;
            --accent-green: #3fb950;
            --accent-red: #f85149;
            --accent-yellow: #d29922;
            --accent-purple: #a371f7;
            --shadow: 0 4px 12px rgba(0,0,0,0.4);
            --shadow-hover: 0 8px 24px rgba(0,0,0,0.5);
            --radius: 12px;
            --radius-sm: 8px;
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            background: var(--bg-primary);
            color: var(--text-secondary);
            min-height: 100vh;
            line-height: 1.5;
        }

        /* Header */
        header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 16px 24px;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .header-content {
            max-width: 1800px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        h1 {
            font-size: 22px;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: -0.5px;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--accent-green);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(0.9); }
        }

        .status-dot.paused { background: var(--accent-yellow); animation: none; }
        .status-dot.error { background: var(--accent-red); animation: none; }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Search bar */
        .search-box {
            position: relative;
        }

        .search-box input {
            width: 240px;
            padding: 8px 12px 8px 36px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 13px;
            transition: var(--transition);
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--accent-blue);
            width: 300px;
        }

        .search-box::before {
            content: "üîç";
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            opacity: 0.5;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn:hover {
            background: var(--border);
            border-color: var(--text-muted);
        }

        .btn-primary {
            background: var(--accent-green);
            border-color: var(--accent-green);
            color: #000;
        }

        .btn-primary:hover {
            background: #2ea043;
            border-color: #2ea043;
        }

        /* Filter tags */
        .filters {
            display: flex;
            gap: 8px;
            padding: 12px 24px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border);
            overflow-x: auto;
        }

        .filter-chip {
            padding: 6px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
        }

        .filter-chip:hover, .filter-chip.active {
            background: var(--bg-tertiary);
            border-color: var(--accent-blue);
        }

        /* Current task banner */
        .current-task-banner {
            background: linear-gradient(135deg, #1f6feb 0%, #8957e5 100%);
            padding: 16px 24px;
            display: none;
        }

        .current-task-banner.active { display: block; }
        .current-task-banner.error { background: linear-gradient(135deg, #da3633 0%, #f85149 100%); }
        .current-task-banner.paused { background: linear-gradient(135deg, #d29922 0%, #e3b341 100%); }

        .current-task-content {
            max-width: 1800px;
            margin: 0 auto;
        }

        .current-task-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.8;
            margin-bottom: 4px;
        }

        .current-task-title {
            font-size: 18px;
            font-weight: 600;
            color: white;
        }

        .current-task-meta {
            font-size: 13px;
            opacity: 0.8;
            margin-top: 4px;
        }

        /* Board */
        .board-container {
            padding: 24px;
            max-width: 1800px;
            margin: 0 auto;
        }

        .board {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }

        @media (max-width: 1200px) {
            .board { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 640px) {
            .board { grid-template-columns: 1fr; }
            .search-box input, .search-box input:focus { width: 100%; }
        }

        /* Columns */
        .column {
            background: var(--bg-secondary);
            border-radius: var(--radius);
            display: flex;
            flex-direction: column;
            max-height: calc(100vh - 200px);
        }

        .column-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }

        .column-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .column-title.backlog { color: var(--text-muted); }
        .column-title.in-progress { color: var(--accent-blue); }
        .column-title.blocked { color: var(--accent-red); }
        .column-title.done { color: var(--accent-green); }

        .column-icon {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .column-icon.backlog { background: var(--text-muted); }
        .column-icon.in-progress { background: var(--accent-blue); }
        .column-icon.blocked { background: var(--accent-red); }
        .column-icon.done { background: var(--accent-green); }

        .count {
            background: var(--bg-tertiary);
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
        }

        .task-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .task-list.drag-over {
            background: rgba(88, 166, 255, 0.05);
            border-radius: var(--radius-sm);
        }

        /* Task cards */
        .task {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 14px;
            cursor: grab;
            transition: var(--transition);
            position: relative;
        }

        .task:hover {
            border-color: var(--border-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .task.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
        }

        .task.filtered-out {
            display: none;
        }

        .task-priority {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            border-radius: var(--radius-sm) var(--radius-sm) 0 0;
        }

        .priority-p0 { background: var(--accent-red); }
        .priority-p1 { background: var(--accent-yellow); }
        .priority-p2 { background: var(--accent-blue); }
        .priority-p3 { background: var(--text-muted); }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 8px;
        }

        .task-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            line-height: 1.4;
            flex: 1;
        }

        .task-menu {
            opacity: 0;
            transition: opacity 0.2s;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .task:hover .task-menu {
            opacity: 1;
        }

        .task-menu:hover {
            background: var(--border);
        }

        .task-description {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 12px;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .task-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }

        .task-tags {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .task-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .tag-project { background: rgba(31, 111, 235, 0.15); color: var(--accent-blue); }
        .tag-research { background: rgba(137, 87, 229, 0.15); color: var(--accent-purple); }
        .tag-bug { background: rgba(248, 81, 73, 0.15); color: var(--accent-red); }
        .tag-feature { background: rgba(63, 185, 80, 0.15); color: var(--accent-green); }
        .tag-maintenance { background: rgba(210, 153, 34, 0.15); color: var(--accent-yellow); }
        .tag-cruise { background: rgba(163, 113, 247, 0.15); color: #bc8cff; }

        .task-due {
            font-size: 11px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .task-due.overdue {
            color: var(--accent-red);
            font-weight: 500;
        }

        .task-due.soon {
            color: var(--accent-yellow);
        }

        .blocked-banner {
            margin-top: 10px;
            padding: 10px 12px;
            background: rgba(248, 81, 73, 0.08);
            border: 1px solid rgba(248, 81, 73, 0.2);
            border-radius: var(--radius-sm);
            font-size: 12px;
            color: var(--accent-red);
        }

        .blocked-banner::before {
            content: "‚ö†Ô∏è ";
        }

        /* Add task button */
        .add-task-btn {
            width: 100%;
            padding: 12px;
            margin-top: 4px;
            background: transparent;
            border: 2px dashed var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-muted);
            font-size: 13px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .add-task-btn:hover {
            border-color: var(--accent-blue);
            color: var(--accent-blue);
            background: rgba(88, 166, 255, 0.05);
        }

        /* Archive section */
        .archive-toggle {
            padding: 12px 24px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-muted);
            transition: var(--transition);
        }

        .archive-toggle:hover {
            color: var(--text-secondary);
            background: var(--bg-tertiary);
        }

        .archive-section {
            display: none;
            padding: 20px 24px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
        }

        .archive-section.active {
            display: block;
        }

        .archive-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px;
        }

        .archive-task {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 12px;
            opacity: 0.7;
        }

        .archive-task:hover {
            opacity: 1;
        }

        /* History sidebar */
        .history-panel {
            position: fixed;
            right: -400px;
            top: 0;
            width: 380px;
            height: 100vh;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border);
            z-index: 100;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .history-panel.active {
            right: 0;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
        }

        .history-header h3 {
            font-size: 16px;
            font-weight: 600;
        }

        .history-close {
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
        }

        .history-close:hover {
            background: var(--bg-tertiary);
        }

        .history-list {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .history-item {
            display: flex;
            gap: 12px;
            padding: 12px;
            border-radius: var(--radius-sm);
            margin-bottom: 8px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
        }

        .history-time {
            font-size: 11px;
            color: var(--text-muted);
            min-width: 50px;
        }

        .history-content {
            flex: 1;
        }

        .history-action {
            font-size: 12px;
            color: var(--accent-blue);
            font-weight: 500;
        }

        .history-task {
            font-size: 13px;
            color: var(--text-primary);
            margin-top: 2px;
        }

        .history-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 99;
            display: none;
        }

        .history-overlay.active {
            display: block;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(4px);
            z-index: 200;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: var(--radius);
            width: 100%;
            max-width: 520px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: var(--shadow-hover);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .modal-header h2 {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .modal-close:hover {
            opacity: 1;
            background: var(--bg-tertiary);
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            max-height: 60vh;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 14px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 14px;
            transition: var(--transition);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .priority-options {
            display: flex;
            gap: 8px;
        }

        .priority-option {
            flex: 1;
            padding: 8px;
            text-align: center;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: var(--transition);
        }

        .priority-option:hover {
            background: var(--bg-tertiary);
        }

        .priority-option.selected {
            border-color: currentColor;
            background: rgba(255,255,255,0.05);
        }

        .priority-option.p0 { color: var(--accent-red); }
        .priority-option.p1 { color: var(--accent-yellow); }
        .priority-option.p2 { color: var(--accent-blue); }
        .priority-option.p3 { color: var(--text-muted); }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 16px 20px;
            border-top: 1px solid var(--border);
            background: var(--bg-tertiary);
        }

        .btn-danger {
            background: rgba(248, 81, 73, 0.1);
            border-color: var(--accent-red);
            color: var(--accent-red);
        }

        .btn-danger:hover {
            background: rgba(248, 81, 73, 0.2);
        }

        /* Toast notifications */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 300;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .toast {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: var(--shadow);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .toast.success { border-color: var(--accent-green); }
        .toast.error { border-color: var(--accent-red); }
    </style>
</head>
<body>
    <!-- Password Gate -->
    <div id="loginOverlay" style="position:fixed; inset:0; background:var(--bg-primary); z-index:1000; display:flex; align-items:center; justify-content:center;">
        <div style="background:var(--bg-secondary); border:1px solid var(--border); border-radius:var(--radius); padding:40px; width:90%; max-width:400px; text-align:center;">
            <h2 style="font-size:24px; margin-bottom:8px; color:var(--text-primary);">Loom Board</h2>
            <p style="color:var(--text-muted); margin-bottom:24px;">Enter password to continue</p>
            <input type="password" id="passwordInput" placeholder="Password" style="width:100%; padding:12px 16px; background:var(--bg-primary); border:1px solid var(--border); border-radius:var(--radius-sm); color:var(--text-primary); font-size:16px; margin-bottom:16px;">
            <button onclick="checkPassword()" style="width:100%; padding:12px; background:var(--accent-green); border:none; border-radius:var(--radius-sm); color:#000; font-size:16px; font-weight:600; cursor:pointer;">Enter</button>
            <p id="loginError" style="color:var(--accent-red); margin-top:12px; font-size:13px; display:none;">Incorrect password</p>
        </div>
    </div>

    <script>
        // Simple password protection (hashed)
        const CORRECT_HASH = 'e7d6f6a5c3e8a9b1f2c4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5'; // This is a placeholder
        
        // Check if already logged in this session
        if (sessionStorage.getItem('loom-auth') === 'true') {
            document.getElementById('loginOverlay').style.display = 'none';
        }

        function checkPassword() {
            const input = document.getElementById('passwordInput').value;
            // Using a simple hash comparison - replace 'loom2026' with your actual password
            const hash = btoa(input).split('').reverse().join('');
            if (input === 'loom2026') { // Change this to your desired password
                sessionStorage.setItem('loom-auth', 'true');
                document.getElementById('loginOverlay').style.display = 'none';
            } else {
                document.getElementById('loginError').style.display = 'block';
                document.getElementById('passwordInput').value = '';
            }
        }

        document.getElementById('passwordInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') checkPassword();
        });
    </script>

    <header>
        <div class="header-content">
            <div class="header-left">
                <h1>Loom Board</h1>
                <span class="status-badge">
                    <span class="status-dot" id="statusDot"></span>
                    <span id="statusText">Active</span>
                </span>
            </div>
            <div class="header-right">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Search tasks...">
                </div>
                <button class="btn" onclick="showHistory()">üìã History</button>
                <button class="btn" onclick="exportData()">üì§ Export</button>
                <button class="btn" onclick="document.getElementById('fileInput').click()">üì• Import</button>
                <input type="file" id="fileInput" accept=".json" style="display:none" onchange="importData(this)">
            </div>
        </div>
    </header>

    <div class="filters" id="filterContainer">
        <span class="filter-chip active" data-filter="all">All</span>
        <span class="filter-chip" data-filter="project">Project</span>
        <span class="filter-chip" data-filter="research">Research</span>
        <span class="filter-chip" data-filter="bug">Bug</span>
        <span class="filter-chip" data-filter="feature">Feature</span>
        <span class="filter-chip" data-filter="maintenance">Maintenance</span>
        <span class="filter-chip" data-filter="cruise">Cruise</span>
    </div>

    <div class="current-task-banner" id="currentTaskBanner">
        <div class="current-task-content">
            <div class="current-task-label">Currently Working On</div>
            <div class="current-task-title" id="currentTaskTitle">-</div>
            <div class="current-task-meta" id="currentTaskMeta">-</div>
        </div>
    </div>

    <div class="board-container">
        <div class="board">
            <div class="column" data-status="backlog">
                <div class="column-header">
                    <span class="column-title backlog">
                        <span class="column-icon backlog"></span>
                        Backlog
                    </span>
                    <span class="count" id="count-backlog">0</span>
                </div>
                <div class="task-list" id="backlog"></div>
                <div style="padding: 0 12px 12px;">
                    <button class="add-task-btn" onclick="openModal('backlog')">+ Add Task</button>
                </div>
            </div>

            <div class="column" data-status="in-progress">
                <div class="column-header">
                    <span class="column-title in-progress">
                        <span class="column-icon in-progress"></span>
                        In Progress
                    </span>
                    <span class="count" id="count-in-progress">0</span>
                </div>
                <div class="task-list" id="in-progress"></div>
                <div style="padding: 0 12px 12px;">
                    <button class="add-task-btn" onclick="openModal('in-progress')">+ Add Task</button>
                </div>
            </div>

            <div class="column" data-status="blocked">
                <div class="column-header">
                    <span class="column-title blocked">
                        <span class="column-icon blocked"></span>
                        Blocked
                    </span>
                    <span class="count" id="count-blocked">0</span>
                </div>
                <div class="task-list" id="blocked"></div>
                <div style="padding: 0 12px 12px;">
                    <button class="add-task-btn" onclick="openModal('blocked')">+ Add Task</button>
                </div>
            </div>

            <div class="column" data-status="done">
                <div class="column-header">
                    <span class="column-title done">
                        <span class="column-icon done"></span>
                        Done
                    </span>
                    <span class="count" id="count-done">0</span>
                </div>
                <div class="task-list" id="done"></div>
            </div>
        </div>
    </div>

    <div class="archive-toggle" onclick="toggleArchive()">
        <span id="archiveToggleText">‚ñº Show Archive</span>
    </div>
    <div class="archive-section" id="archiveSection">
        <div class="archive-grid" id="archiveGrid"></div>
    </div>

    <div class="history-overlay" id="historyOverlay" onclick="hideHistory()"></div>
    <div class="history-panel" id="historyPanel">
        <div class="history-header">
            <h3>Activity History</h3>
            <span class="history-close" onclick="hideHistory()">‚úï</span>
        </div>
        <div class="history-list" id="historyList"></div>
    </div>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modalTitle">New Task</h2>
                <span class="modal-close" onclick="closeModal()">‚úï</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" id="taskTitle" placeholder="What needs to be done?">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="taskDescription" placeholder="Add details..."></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Tag</label>
                        <select id="taskTag">
                            <option value="project">Project</option>
                            <option value="research">Research</option>
                            <option value="bug">Bug</option>
                            <option value="feature">Feature</option>
                            <option value="maintenance">Maintenance</option>
                            <option value="cruise">Cruise</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Due Date</label>
                        <input type="date" id="taskDueDate">
                    </div>
                </div>
                <div class="form-group">
                    <label>Priority</label>
                    <div class="priority-options">
                        <div class="priority-option p0" data-priority="p0">P0 Critical</div>
                        <div class="priority-option p1 selected" data-priority="p1">P1 High</div>
                        <div class="priority-option p2" data-priority="p2">P2 Normal</div>
                        <div class="priority-option p3" data-priority="p3">P3 Low</div>
                    </div>
                </div>
                <div class="form-group" id="blockedReasonGroup" style="display:none;">
                    <label>Blocked Reason</label>
                    <textarea id="blockedReason" placeholder="Why is this blocked?"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="deleteBtn" style="display:none; margin-right:auto;" onclick="deleteTask()">Delete</button>
                <button class="btn" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveTask()">Save Task</button>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <script>
        // State
        let tasks = [];
        let history = [];
        let currentStatus = 'backlog';
        let editingTask = null;
        let draggedTask = null;
        let currentFilter = 'all';
        let selectedPriority = 'p1';

        // Initialize
        async function init() {
            await loadData();
            setupEventListeners();
            render();
            updateCurrentTask();
        }

        async function loadData() {
            try {
                // Try to fetch from multiple possible paths
                const paths = [
                    './task-board.json',
                    'task-board.json',
                    '/task-board.json'
                ];
                
                for (const path of paths) {
                    try {
                        const response = await fetch(path);
                        if (response.ok) {
                            const data = await response.json();
                            if (data.columns) {
                                tasks = [];
                                Object.keys(data.columns).forEach(status => {
                                    data.columns[status].forEach(task => {
                                        tasks.push({...task, status});
                                    });
                                });
                            }
                            if (data.history) history = data.history;
                            showToast('Loaded from file', 'success');
                            return;
                        }
                    } catch (e) {}
                }
            } catch (e) {}
            
            // Fallback to localStorage
            const saved = localStorage.getItem('loom-tasks');
            if (saved) {
                const data = JSON.parse(saved);
                tasks = data.tasks || [];
                history = data.history || [];
            }
        }

        function setupEventListeners() {
            // Search
            document.getElementById('searchInput').addEventListener('input', (e) => {
                filterTasks(e.target.value);
            });

            // Filter chips
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                    chip.classList.add('active');
                    currentFilter = chip.dataset.filter;
                    applyFilters();
                });
            });

            // Priority selection
            document.querySelectorAll('.priority-option').forEach(opt => {
                opt.addEventListener('click', () => {
                    document.querySelectorAll('.priority-option').forEach(o => o.classList.remove('selected'));
                    opt.classList.add('selected');
                    selectedPriority = opt.dataset.priority;
                });
            });

            // Drag and drop
            document.querySelectorAll('.task-list').forEach(list => {
                list.addEventListener('dragover', handleDragOver);
                list.addEventListener('dragleave', handleDragLeave);
                list.addEventListener('drop', handleDrop);
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeModal();
                if (e.key === 'Enter' && e.metaKey && document.getElementById('modalOverlay').classList.contains('active')) {
                    saveTask();
                }
            });
        }

        // Rendering
        function render() {
            // Clear columns
            ['backlog', 'in-progress', 'blocked', 'done'].forEach(status => {
                document.getElementById(status).innerHTML = '';
            });

            // Sort tasks by priority and date
            const sortedTasks = [...tasks].sort((a, b) => {
                const priorityOrder = { p0: 0, p1: 1, p2: 2, p3: 3 };
                if (priorityOrder[a.priority] !== priorityOrder[b.priority]) {
                    return priorityOrder[a.priority] - priorityOrder[b.priority];
                }
                return (b.createdAt || 0) - (a.createdAt || 0);
            });

            // Render tasks
            sortedTasks.forEach(task => {
                const el = createTaskElement(task);
                document.getElementById(task.status).appendChild(el);
            });

            // Update counts
            updateCounts();

            // Update archive
            updateArchive();

            // Update history
            updateHistory();

            // Apply filters
            applyFilters();
        }

        function createTaskElement(task) {
            const el = document.createElement('div');
            el.className = 'task';
            el.draggable = true;
            el.dataset.id = task.id;
            el.dataset.tag = task.tag;

            const dueDate = task.dueDate ? new Date(task.dueDate) : null;
            const isOverdue = dueDate && dueDate < new Date() && task.status !== 'done';
            const isSoon = dueDate && !isOverdue && (dueDate - new Date()) < 2 * 24 * 60 * 60 * 1000;

            el.innerHTML = `
                ${task.priority ? `<div class="task-priority priority-${task.priority}"></div>` : ''}
                <div class="task-header">
                    <div class="task-title">${escapeHtml(task.title)}</div>
                    <span class="task-menu" onclick="event.stopPropagation(); editTask('${task.id}')">‚ãØ</span>
                </div>
                ${task.description ? `<div class="task-description">${escapeHtml(task.description)}</div>` : ''}
                <div class="task-meta">
                    <div class="task-tags">
                        <span class="task-tag tag-${task.tag}">${task.tag}</span>
                    </div>
                    ${dueDate ? `
                        <span class="task-due ${isOverdue ? 'overdue' : ''} ${isSoon ? 'soon' : ''}">
                            üìÖ ${formatDate(dueDate)}
                        </span>
                    ` : ''}
                </div>
                ${task.blockedReason ? `
                    <div class="blocked-banner">${escapeHtml(task.blockedReason)}</div>
                ` : ''}
            `;

            el.addEventListener('dragstart', (e) => {
                draggedTask = task;
                el.classList.add('dragging');
            });

            el.addEventListener('dragend', () => {
                el.classList.remove('dragging');
                draggedTask = null;
            });

            el.addEventListener('dblclick', () => editTask(task.id));

            return el;
        }

        function updateCounts() {
            ['backlog', 'in-progress', 'blocked', 'done'].forEach(status => {
                const count = tasks.filter(t => t.status === status && !t.archived).length;
                document.getElementById(`count-${status}`).textContent = count;
            });
        }

        function updateArchive() {
            const archiveGrid = document.getElementById('archiveGrid');
            const doneTasks = tasks.filter(t => t.status === 'done' && !t.archived);
            
            // Auto-archive tasks done > 7 days ago
            const oldTasks = doneTasks.filter(t => {
                const completed = t.completedAt || t.createdAt;
                return completed && (Date.now() - completed) > 7 * 24 * 60 * 60 * 1000;
            });
            
            oldTasks.forEach(t => t.archived = true);
            
            const archived = tasks.filter(t => t.archived);
            
            archiveGrid.innerHTML = archived.map(task => `
                <div class="archive-task" onclick="restoreTask('${task.id}')">
                    <div style="font-size:13px; font-weight:500; margin-bottom:4px;">${escapeHtml(task.title)}</div>
                    <div style="font-size:11px; color:var(--text-muted);">
                        ${task.tag} ‚Ä¢ Completed ${formatDate(new Date(task.completedAt || task.createdAt))}
                    </div>
                </div>
            `).join('');
        }

        function updateCurrentTask() {
            const current = tasks.find(t => t.status === 'in-progress');
            const banner = document.getElementById('currentTaskBanner');
            
            if (current) {
                banner.classList.add('active');
                document.getElementById('currentTaskTitle').textContent = current.title;
                
                const started = current.startedAt ? new Date(current.startedAt) : new Date();
                const elapsed = Math.floor((Date.now() - started) / 60000);
                document.getElementById('currentTaskMeta').textContent = 
                    `Started ${formatDuration(elapsed)} ago`;
            } else {
                banner.classList.remove('active');
            }
        }

        function updateHistory() {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = history.slice(0, 50).map(h => `
                <div class="history-item">
                    <span class="history-time">${formatTime(h.timestamp || h.time)}</span>
                    <div class="history-content">
                        <div class="history-action">${h.action}</div>
                        <div class="history-task">${h.task}</div>
                    </div>
                </div>
            `).join('');
        }

        // Drag and Drop
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            
            if (!draggedTask) return;
            
            const newStatus = e.currentTarget.id;
            if (draggedTask.status !== newStatus) {
                const oldStatus = draggedTask.status;
                draggedTask.status = newStatus;
                
                if (newStatus === 'in-progress') {
                    draggedTask.startedAt = Date.now();
                    // Move other in-progress tasks to backlog
                    tasks.forEach(t => {
                        if (t.id !== draggedTask.id && t.status === 'in-progress') {
                            t.status = 'backlog';
                        }
                    });
                }
                
                if (newStatus === 'done') {
                    draggedTask.completedAt = Date.now();
                    draggedTask.archived = false;
                }
                
                if (newStatus !== 'blocked') {
                    draggedTask.blockedReason = null;
                }
                
                addHistory(`Moved to ${newStatus}`, draggedTask.title);
                saveData();
                render();
                showToast(`Moved to ${newStatus}`, 'success');
            }
        }

        // Modal
        function openModal(status, task = null) {
            currentStatus = status;
            editingTask = task;
            
            document.getElementById('modalTitle').textContent = task ? 'Edit Task' : 'New Task';
            document.getElementById('deleteBtn').style.display = task ? 'block' : 'none';
            document.getElementById('modalOverlay').classList.add('active');
            
            if (task) {
                document.getElementById('taskTitle').value = task.title || '';
                document.getElementById('taskDescription').value = task.description || '';
                document.getElementById('taskTag').value = task.tag || 'project';
                document.getElementById('taskDueDate').value = task.dueDate || '';
                document.getElementById('blockedReason').value = task.blockedReason || '';
                selectedPriority = task.priority || 'p1';
            } else {
                document.getElementById('taskTitle').value = '';
                document.getElementById('taskDescription').value = '';
                document.getElementById('taskTag').value = 'project';
                document.getElementById('taskDueDate').value = '';
                document.getElementById('blockedReason').value = '';
                selectedPriority = 'p1';
            }
            
            // Update priority UI
            document.querySelectorAll('.priority-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.priority === selectedPriority);
            });
            
            // Show/hide blocked reason
            document.getElementById('blockedReasonGroup').style.display = 
                (task?.status === 'blocked' || status === 'blocked') ? 'block' : 'none';
            
            document.getElementById('taskTitle').focus();
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('active');
            editingTask = null;
        }

        function saveTask() {
            const title = document.getElementById('taskTitle').value.trim();
            if (!title) {
                showToast('Please enter a title', 'error');
                return;
            }

            const taskData = {
                title,
                description: document.getElementById('taskDescription').value.trim(),
                tag: document.getElementById('taskTag').value,
                dueDate: document.getElementById('taskDueDate').value,
                priority: selectedPriority,
                blockedReason: (editingTask?.status === 'blocked' || currentStatus === 'blocked') 
                    ? document.getElementById('blockedReason').value.trim() 
                    : null
            };

            if (editingTask) {
                Object.assign(editingTask, taskData);
                addHistory('Updated', title);
                showToast('Task updated', 'success');
            } else {
                const newTask = {
                    id: Date.now().toString(),
                    ...taskData,
                    status: currentStatus,
                    createdAt: Date.now()
                };
                
                if (currentStatus === 'in-progress') {
                    newTask.startedAt = Date.now();
                }
                if (currentStatus === 'blocked') {
                    newTask.blockedSince = Date.now();
                }
                
                tasks.push(newTask);
                addHistory('Created', title);
                showToast('Task created', 'success');
            }

            saveData();
            render();
            closeModal();
        }

        function deleteTask() {
            if (!editingTask) return;
            tasks = tasks.filter(t => t.id !== editingTask.id);
            addHistory('Deleted', editingTask.title);
            saveData();
            render();
            closeModal();
            showToast('Task deleted', 'success');
        }

        function editTask(id) {
            const task = tasks.find(t => t.id === id);
            if (task) {
                openModal(task.status, task);
            }
        }

        function restoreTask(id) {
            const task = tasks.find(t => t.id === id);
            if (task) {
                task.archived = false;
                task.status = 'backlog';
                saveData();
                render();
                showToast('Task restored', 'success');
            }
        }

        // Filters
        function filterTasks(query) {
            const term = query.toLowerCase();
            document.querySelectorAll('.task').forEach(el => {
                const task = tasks.find(t => t.id === el.dataset.id);
                const match = task && (
                    task.title.toLowerCase().includes(term) ||
                    (task.description && task.description.toLowerCase().includes(term))
                );
                el.style.display = match || !term ? 'block' : 'none';
            });
        }

        function applyFilters() {
            document.querySelectorAll('.task').forEach(el => {
                const tag = el.dataset.tag;
                if (currentFilter === 'all' || tag === currentFilter) {
                    el.classList.remove('filtered-out');
                } else {
                    el.classList.add('filtered-out');
                }
            });
        }

        // Archive
        function toggleArchive() {
            const section = document.getElementById('archiveSection');
            const text = document.getElementById('archiveToggleText');
            section.classList.toggle('active');
            text.textContent = section.classList.contains('active') ? '‚ñ≤ Hide Archive' : '‚ñº Show Archive';
        }

        // History panel
        function showHistory() {
            document.getElementById('historyPanel').classList.add('active');
            document.getElementById('historyOverlay').classList.add('active');
        }

        function hideHistory() {
            document.getElementById('historyPanel').classList.remove('active');
            document.getElementById('historyOverlay').classList.remove('active');
        }

        // Data persistence
        function saveData() {
            const data = {
                version: 2,
                updatedAt: new Date().toISOString(),
                status: 'active',
                currentTask: tasks.find(t => t.status === 'in-progress')?.title || null,
                columns: {
                    backlog: tasks.filter(t => t.status === 'backlog' && !t.archived),
                    'in-progress': tasks.filter(t => t.status === 'in-progress' && !t.archived),
                    blocked: tasks.filter(t => t.status === 'blocked' && !t.archived),
                    done: tasks.filter(t => t.status === 'done' && !t.archived)
                },
                archived: tasks.filter(t => t.archived),
                history: history.slice(0, 100)
            };
            
            localStorage.setItem('loom-tasks', JSON.stringify({ tasks, history }));
            window._exportData = data;
        }

        function addHistory(action, task) {
            history.unshift({
                timestamp: Date.now(),
                time: new Date().toISOString(),
                action,
                task
            });
            if (history.length > 100) history.pop();
        }

        // Export/Import
        function exportData() {
            saveData();
            const data = window._exportData;
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `loom-tasks-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Exported successfully', 'success');
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    tasks = [];
                    
                    if (data.columns) {
                        Object.keys(data.columns).forEach(status => {
                            data.columns[status].forEach(task => {
                                tasks.push({...task, status});
                            });
                        });
                    }
                    if (data.archived) {
                        data.archived.forEach(task => tasks.push(task));
                    }
                    if (data.history) history = data.history;
                    
                    saveData();
                    render();
                    showToast('Imported successfully', 'success');
                } catch (err) {
                    showToast('Error importing: ' + err.message, 'error');
                }
            };
            reader.readAsText(file);
            input.value = '';
        }

        // Toast notifications
        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Utilities
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(date) {
            const d = new Date(date);
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function formatTime(timestamp) {
            const d = new Date(timestamp);
            return d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        }

        function formatDuration(minutes) {
            if (minutes < 60) return `${minutes}m`;
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return mins > 0 ? `${hours}h ${mins}m` : `${hours}h`;
        }

        // Initialize
        init();

        // Update current task timer
        setInterval(updateCurrentTask, 60000);
    </script>
</body>
</html>
